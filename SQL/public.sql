-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.ab_test_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  test_name text NOT NULL UNIQUE,
  description text,
  hypothesis text,
  variants jsonb NOT NULL DEFAULT '[]'::jsonb,
  traffic_split jsonb DEFAULT '{"control": 50, "variant": 50}'::jsonb,
  target_metric text,
  target_segments ARRAY,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'running'::text, 'paused'::text, 'completed'::text, 'archived'::text])),
  started_at timestamp with time zone,
  ended_at timestamp with time zone,
  winner_variant text,
  confidence_level numeric,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ab_test_configs_pkey PRIMARY KEY (id),
  CONSTRAINT ab_test_configs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.ad_campaigns (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  campaign_name text NOT NULL,
  campaign_type text CHECK (campaign_type = ANY (ARRAY['retarget'::text, 'awareness'::text, 'conversion'::text, 'retention'::text, 'win_back'::text, 'lookalike'::text])),
  target_segment ARRAY,
  target_funnel_levels ARRAY,
  channel ARRAY CHECK (channel <@ ARRAY['push'::text, 'email'::text, 'sms'::text, 'whatsapp'::text, 'in_app'::text, 'banner'::text]),
  product_ids ARRAY,
  message_title text,
  message_body text,
  offer_type text CHECK (offer_type IS NULL OR (offer_type = ANY (ARRAY['discount'::text, 'free_shipping'::text, 'gift'::text, 'early_access'::text, 'none'::text]))),
  offer_value numeric,
  budget numeric,
  spent numeric DEFAULT 0.00,
  impressions integer DEFAULT 0,
  clicks integer DEFAULT 0,
  conversions integer DEFAULT 0,
  revenue_generated numeric DEFAULT 0.00,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'active'::text, 'paused'::text, 'completed'::text, 'cancelled'::text])),
  start_at timestamp with time zone,
  end_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ad_campaigns_pkey PRIMARY KEY (id)
);
CREATE TABLE public.admin_roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  role_name text NOT NULL UNIQUE,
  description text,
  permissions jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_roles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.admin_users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  role_id uuid NOT NULL,
  is_active boolean DEFAULT true,
  assigned_by uuid,
  assigned_at timestamp with time zone DEFAULT now(),
  last_action_at timestamp with time zone,
  CONSTRAINT admin_users_pkey PRIMARY KEY (id),
  CONSTRAINT admin_users_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT admin_users_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.admin_roles(id),
  CONSTRAINT admin_users_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.users(id)
);
CREATE TABLE public.affiliate_clicks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  affiliate_id uuid NOT NULL,
  product_id text,
  ip_address inet,
  device_type text,
  referrer_url text,
  converted boolean DEFAULT false,
  conversion_value numeric DEFAULT 0.00,
  commission_earned numeric DEFAULT 0.00,
  clicked_at timestamp with time zone DEFAULT now(),
  converted_at timestamp with time zone,
  CONSTRAINT affiliate_clicks_pkey PRIMARY KEY (id),
  CONSTRAINT affiliate_clicks_affiliate_id_fkey FOREIGN KEY (affiliate_id) REFERENCES public.affiliate_partners(id)
);
CREATE TABLE public.affiliate_partners (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  affiliate_code text NOT NULL UNIQUE,
  commission_rate numeric DEFAULT 5.00,
  commission_type text DEFAULT 'percent'::text CHECK (commission_type = ANY (ARRAY['percent'::text, 'fixed'::text])),
  total_clicks integer DEFAULT 0,
  total_conversions integer DEFAULT 0,
  total_earned numeric DEFAULT 0.00,
  pending_payout numeric DEFAULT 0.00,
  paid_out_total numeric DEFAULT 0.00,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'suspended'::text, 'terminated'::text])),
  payout_method text,
  payout_account text,
  approved_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT affiliate_partners_pkey PRIMARY KEY (id),
  CONSTRAINT affiliate_partners_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.ai_conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  title text DEFAULT 'New Conversation'::text,
  model text DEFAULT 'zipra-ai'::text,
  total_messages integer DEFAULT 0,
  total_tokens integer DEFAULT 0,
  is_pinned boolean DEFAULT false,
  is_archived boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT ai_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.ai_generated_content (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  content_type text CHECK (content_type = ANY (ARRAY['text'::text, 'image'::text, 'code'::text, 'email'::text, 'document'::text, 'social_post'::text, 'product_description'::text])),
  prompt text NOT NULL,
  generated_content text NOT NULL,
  model_used text,
  quality_score numeric,
  is_used boolean DEFAULT false,
  is_public boolean DEFAULT false,
  edited_version text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_generated_content_pkey PRIMARY KEY (id),
  CONSTRAINT ai_generated_content_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.ai_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['user'::text, 'assistant'::text, 'system'::text])),
  content text NOT NULL,
  tokens_used integer DEFAULT 0,
  model_used text,
  is_liked boolean,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_messages_pkey PRIMARY KEY (id),
  CONSTRAINT ai_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.ai_conversations(id)
);
CREATE TABLE public.ai_product_recommendations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  recommendation_score numeric NOT NULL CHECK (recommendation_score >= 0::numeric AND recommendation_score <= 1::numeric),
  reasoning jsonb,
  model_version text,
  factors jsonb,
  is_shown boolean DEFAULT false,
  is_clicked boolean DEFAULT false,
  is_purchased boolean DEFAULT false,
  generated_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  CONSTRAINT ai_product_recommendations_pkey PRIMARY KEY (id),
  CONSTRAINT ai_product_recommendations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.ai_usage_stats (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  total_conversations integer DEFAULT 0,
  total_messages integer DEFAULT 0,
  total_tokens_used bigint DEFAULT 0,
  monthly_token_limit bigint DEFAULT 100000,
  monthly_tokens_used bigint DEFAULT 0,
  reset_date date DEFAULT date_trunc('month'::text, (now() + '1 mon'::interval)),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_usage_stats_pkey PRIMARY KEY (id),
  CONSTRAINT ai_usage_stats_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.api_keys (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  key_name text NOT NULL,
  key_hash text NOT NULL UNIQUE,
  key_prefix text NOT NULL,
  permissions ARRAY DEFAULT ARRAY['read'::text],
  rate_limit_per_hour integer DEFAULT 1000,
  is_active boolean DEFAULT true,
  last_used_at timestamp with time zone,
  usage_count integer DEFAULT 0,
  expires_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  allowed_ips ARRAY,
  allowed_domains ARRAY,
  webhook_secret text,
  daily_limit integer DEFAULT 10000,
  monthly_limit integer DEFAULT 100000,
  description text,
  CONSTRAINT api_keys_pkey PRIMARY KEY (id),
  CONSTRAINT api_keys_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.api_usage_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  api_key_id uuid,
  user_id uuid,
  app_id uuid,
  endpoint text NOT NULL,
  method text NOT NULL CHECK (method = ANY (ARRAY['GET'::text, 'POST'::text, 'PUT'::text, 'PATCH'::text, 'DELETE'::text])),
  status_code integer,
  response_time_ms integer,
  request_size_bytes integer,
  response_size_bytes integer,
  ip_address inet,
  error_message text,
  created_at timestamp with time zone DEFAULT now(),
  oauth_app_id uuid,
  CONSTRAINT api_usage_logs_pkey PRIMARY KEY (id),
  CONSTRAINT api_usage_logs_api_key_id_fkey FOREIGN KEY (api_key_id) REFERENCES public.api_keys(id),
  CONSTRAINT api_usage_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT api_usage_logs_oauth_app_id_fkey FOREIGN KEY (oauth_app_id) REFERENCES public.oauth_applications(id)
);
CREATE TABLE public.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  actor_id uuid,
  actor_role text,
  target_table text,
  target_id text,
  action text NOT NULL CHECK (action = ANY (ARRAY['create'::text, 'read'::text, 'update'::text, 'delete'::text, 'login'::text, 'logout'::text, 'ban'::text, 'unban'::text, 'role_assign'::text, 'config_change'::text, 'export'::text, 'import'::text])),
  old_data jsonb,
  new_data jsonb,
  ip_address inet,
  user_agent text,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_actor_id_fkey FOREIGN KEY (actor_id) REFERENCES public.users(id)
);
CREATE TABLE public.authorized_apps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  app_name text NOT NULL,
  app_domain text NOT NULL UNIQUE,
  app_secret text NOT NULL,
  redirect_uri text NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  migrated_to_zipra_app_id uuid,
  is_deprecated boolean DEFAULT true,
  CONSTRAINT authorized_apps_pkey PRIMARY KEY (id),
  CONSTRAINT authorized_apps_migrated_to_zipra_app_id_fkey FOREIGN KEY (migrated_to_zipra_app_id) REFERENCES public.zipra_apps(id)
);
CREATE TABLE public.badges (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  badge_name text NOT NULL UNIQUE,
  badge_slug text NOT NULL UNIQUE,
  description text,
  icon_svg text,
  icon_url text,
  category text CHECK (category = ANY (ARRAY['purchase'::text, 'loyalty'::text, 'social'::text, 'referral'::text, 'engagement'::text, 'milestone'::text, 'special'::text, 'seasonal'::text])),
  rarity text DEFAULT 'common'::text CHECK (rarity = ANY (ARRAY['common'::text, 'uncommon'::text, 'rare'::text, 'epic'::text, 'legendary'::text])),
  points_reward integer DEFAULT 0,
  condition_type text,
  condition_value integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  parent_badge_id uuid,
  achievement_tier integer DEFAULT 1,
  is_secret boolean DEFAULT false,
  CONSTRAINT badges_pkey PRIMARY KEY (id),
  CONSTRAINT badges_parent_badge_id_fkey FOREIGN KEY (parent_badge_id) REFERENCES public.badges(id)
);
CREATE TABLE public.bank_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_holder_name text NOT NULL,
  bank_name text NOT NULL,
  account_number_masked text NOT NULL,
  routing_number text,
  swift_code text,
  iban text,
  account_type text DEFAULT 'savings'::text CHECK (account_type = ANY (ARRAY['savings'::text, 'current'::text, 'checking'::text])),
  currency text DEFAULT 'BDT'::text,
  is_verified boolean DEFAULT false,
  is_default boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT bank_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT bank_accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.bnpl_plans (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  order_id text NOT NULL,
  total_amount numeric NOT NULL,
  installments integer NOT NULL CHECK (installments = ANY (ARRAY[3, 4, 6, 12])),
  installment_amount numeric NOT NULL,
  paid_installments integer DEFAULT 0,
  next_payment_date date,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'completed'::text, 'defaulted'::text, 'cancelled'::text])),
  provider text CHECK (provider = ANY (ARRAY['internal'::text, 'klarna'::text, 'afterpay'::text, 'affirm'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT bnpl_plans_pkey PRIMARY KEY (id),
  CONSTRAINT bnpl_plans_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.calendar_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  title text NOT NULL,
  description text,
  location text,
  type text DEFAULT 'personal'::text CHECK (type = ANY (ARRAY['personal'::text, 'work'::text, 'reminder'::text, 'birthday'::text, 'holiday'::text, 'zipra_event'::text, 'other'::text])),
  color text DEFAULT '#6366f1'::text,
  start_at timestamp with time zone NOT NULL,
  end_at timestamp with time zone,
  is_all_day boolean DEFAULT false,
  is_recurring boolean DEFAULT false,
  recurrence_rule text,
  reminder_minutes ARRAY DEFAULT ARRAY[30],
  guests ARRAY,
  is_private boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT calendar_events_pkey PRIMARY KEY (id),
  CONSTRAINT calendar_events_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.captcha_challenges (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id text NOT NULL,
  ip_address inet,
  challenge_type text DEFAULT 'hcaptcha'::text CHECK (challenge_type = ANY (ARRAY['hcaptcha'::text, 'recaptcha'::text, 'turnstile'::text, 'image'::text, 'math'::text])),
  is_solved boolean DEFAULT false,
  attempts integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  solved_at timestamp with time zone,
  expires_at timestamp with time zone DEFAULT (now() + '00:10:00'::interval),
  CONSTRAINT captcha_challenges_pkey PRIMARY KEY (id)
);
CREATE TABLE public.chat_conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  support_agent_id uuid,
  status text DEFAULT 'open'::text CHECK (status = ANY (ARRAY['open'::text, 'active'::text, 'waiting'::text, 'resolved'::text, 'closed'::text])),
  channel text DEFAULT 'live_chat'::text CHECK (channel = ANY (ARRAY['live_chat'::text, 'email'::text, 'whatsapp'::text, 'telegram'::text])),
  subject text,
  last_message_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  rating integer CHECK (rating IS NULL OR rating >= 1 AND rating <= 5),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chat_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT chat_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT chat_conversations_support_agent_id_fkey FOREIGN KEY (support_agent_id) REFERENCES public.users(id)
);
CREATE TABLE public.chat_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  sender_id uuid,
  sender_type text NOT NULL CHECK (sender_type = ANY (ARRAY['user'::text, 'agent'::text, 'bot'::text, 'system'::text])),
  message_type text DEFAULT 'text'::text CHECK (message_type = ANY (ARRAY['text'::text, 'image'::text, 'file'::text, 'audio'::text, 'system_note'::text])),
  content text NOT NULL,
  attachment_url text,
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chat_messages_pkey PRIMARY KEY (id),
  CONSTRAINT chat_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chat_conversations(id),
  CONSTRAINT chat_messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(id)
);
CREATE TABLE public.circle_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  circle_id uuid NOT NULL,
  member_user_id uuid NOT NULL,
  added_at timestamp with time zone DEFAULT now(),
  CONSTRAINT circle_members_pkey PRIMARY KEY (id),
  CONSTRAINT circle_members_circle_id_fkey FOREIGN KEY (circle_id) REFERENCES public.user_circles(id),
  CONSTRAINT circle_members_member_user_id_fkey FOREIGN KEY (member_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.cohort_data (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  cohort_month date NOT NULL,
  months_since_join integer NOT NULL,
  user_count integer DEFAULT 0,
  retained_count integer DEFAULT 0,
  retention_rate numeric DEFAULT 0,
  revenue_generated numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT cohort_data_pkey PRIMARY KEY (id)
);
CREATE TABLE public.collaborative_tasks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workspace_id uuid,
  task_title text NOT NULL,
  description text,
  assigned_to uuid,
  created_by uuid,
  priority text CHECK (priority = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'urgent'::text])),
  status text DEFAULT 'todo'::text CHECK (status = ANY (ARRAY['todo'::text, 'in_progress'::text, 'in_review'::text, 'completed'::text, 'cancelled'::text])),
  due_date timestamp with time zone,
  tags ARRAY,
  attachments jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT collaborative_tasks_pkey PRIMARY KEY (id),
  CONSTRAINT collaborative_tasks_workspace_id_fkey FOREIGN KEY (workspace_id) REFERENCES public.shared_workspaces(id),
  CONSTRAINT collaborative_tasks_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.users(id),
  CONSTRAINT collaborative_tasks_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.collection_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  collection_id uuid NOT NULL,
  item_type text NOT NULL CHECK (item_type = ANY (ARRAY['product'::text, 'media'::text, 'post'::text, 'url'::text, 'note'::text])),
  item_id text NOT NULL,
  notes text,
  position integer DEFAULT 0,
  added_at timestamp with time zone DEFAULT now(),
  CONSTRAINT collection_items_pkey PRIMARY KEY (id),
  CONSTRAINT collection_items_collection_id_fkey FOREIGN KEY (collection_id) REFERENCES public.user_collections(id)
);
CREATE TABLE public.community_comments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  post_id uuid NOT NULL,
  user_id uuid NOT NULL,
  parent_comment_id uuid,
  body text NOT NULL,
  like_count integer DEFAULT 0,
  is_approved boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT community_comments_pkey PRIMARY KEY (id),
  CONSTRAINT community_comments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT community_comments_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.community_posts(id),
  CONSTRAINT community_comments_parent_comment_id_fkey FOREIGN KEY (parent_comment_id) REFERENCES public.community_comments(id)
);
CREATE TABLE public.community_likes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  post_id uuid,
  comment_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT community_likes_pkey PRIMARY KEY (id),
  CONSTRAINT community_likes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT community_likes_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.community_posts(id),
  CONSTRAINT community_likes_comment_id_fkey FOREIGN KEY (comment_id) REFERENCES public.community_comments(id)
);
CREATE TABLE public.community_posts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  type text DEFAULT 'post'::text CHECK (type = ANY (ARRAY['post'::text, 'question'::text, 'review'::text, 'tip'::text, 'discussion'::text])),
  title text,
  body text NOT NULL,
  image_urls ARRAY,
  product_id text,
  tags ARRAY,
  like_count integer DEFAULT 0,
  comment_count integer DEFAULT 0,
  view_count integer DEFAULT 0,
  is_pinned boolean DEFAULT false,
  is_approved boolean DEFAULT true,
  status text DEFAULT 'published'::text CHECK (status = ANY (ARRAY['draft'::text, 'published'::text, 'hidden'::text, 'deleted'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT community_posts_pkey PRIMARY KEY (id),
  CONSTRAINT community_posts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.competitor_insights (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  competitor_name text NOT NULL,
  website text,
  category text,
  pricing_info jsonb,
  features_list ARRAY,
  strengths ARRAY,
  weaknesses ARRAY,
  market_share_estimate numeric,
  notes text,
  last_updated timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT competitor_insights_pkey PRIMARY KEY (id)
);
CREATE TABLE public.content_filters (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  filter_type text NOT NULL CHECK (filter_type = ANY (ARRAY['word'::text, 'phrase'::text, 'regex'::text, 'domain'::text, 'email_pattern'::text])),
  value text NOT NULL,
  action text DEFAULT 'block'::text CHECK (action = ANY (ARRAY['block'::text, 'flag'::text, 'replace'::text, 'warn'::text])),
  replacement text,
  category text CHECK (category = ANY (ARRAY['spam'::text, 'hate_speech'::text, 'profanity'::text, 'adult'::text, 'scam'::text, 'competitor'::text])),
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT content_filters_pkey PRIMARY KEY (id),
  CONSTRAINT content_filters_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.content_posts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  author_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['blog'::text, 'news'::text, 'announcement'::text, 'tutorial'::text, 'update'::text, 'faq'::text])),
  title text NOT NULL,
  slug text NOT NULL UNIQUE,
  excerpt text,
  body text NOT NULL,
  cover_image_url text,
  tags ARRAY,
  category text,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'published'::text, 'archived'::text, 'scheduled'::text])),
  is_featured boolean DEFAULT false,
  view_count integer DEFAULT 0,
  like_count integer DEFAULT 0,
  comment_count integer DEFAULT 0,
  reading_time_minutes integer DEFAULT 1,
  target_segments ARRAY,
  target_countries ARRAY,
  published_at timestamp with time zone,
  scheduled_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT content_posts_pkey PRIMARY KEY (id),
  CONSTRAINT content_posts_author_id_fkey FOREIGN KEY (author_id) REFERENCES public.users(id)
);
CREATE TABLE public.content_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  reporter_id uuid NOT NULL,
  content_type text NOT NULL CHECK (content_type = ANY (ARRAY['media'::text, 'comment'::text, 'review'::text, 'post'::text, 'user_profile'::text, 'message'::text, 'product'::text])),
  content_id text NOT NULL,
  reason text NOT NULL CHECK (reason = ANY (ARRAY['spam'::text, 'hate_speech'::text, 'violence'::text, 'nudity'::text, 'misinformation'::text, 'copyright'::text, 'harassment'::text, 'illegal'::text, 'other'::text])),
  description text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'reviewing'::text, 'actioned'::text, 'dismissed'::text])),
  reviewed_by uuid,
  action_taken text,
  reviewed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT content_reports_pkey PRIMARY KEY (id),
  CONSTRAINT content_reports_reporter_id_fkey FOREIGN KEY (reporter_id) REFERENCES public.users(id),
  CONSTRAINT content_reports_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.users(id)
);
CREATE TABLE public.content_versions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  content_id uuid NOT NULL,
  content_type text NOT NULL CHECK (content_type = ANY (ARRAY['post'::text, 'note'::text, 'product'::text, 'page'::text, 'email_template'::text])),
  version_number integer NOT NULL DEFAULT 1,
  title text,
  body text,
  metadata jsonb DEFAULT '{}'::jsonb,
  changed_by uuid,
  change_summary text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT content_versions_pkey PRIMARY KEY (id),
  CONSTRAINT content_versions_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.users(id)
);
CREATE TABLE public.country_settings (
  code text NOT NULL,
  name text NOT NULL,
  flag_emoji text,
  currency text,
  phone_code text,
  language text,
  timezone text,
  tax_rate numeric DEFAULT 0,
  is_active boolean DEFAULT true,
  CONSTRAINT country_settings_pkey PRIMARY KEY (code)
);
CREATE TABLE public.coupon_usage_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  coupon_id uuid NOT NULL,
  user_id uuid NOT NULL,
  order_id text,
  discount_applied numeric NOT NULL,
  used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT coupon_usage_history_pkey PRIMARY KEY (id),
  CONSTRAINT coupon_usage_history_coupon_id_fkey FOREIGN KEY (coupon_id) REFERENCES public.promo_codes(id),
  CONSTRAINT coupon_usage_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.cron_job_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  job_name text NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['running'::text, 'completed'::text, 'failed'::text, 'skipped'::text])),
  rows_processed integer DEFAULT 0,
  duration_ms integer,
  error_message text,
  metadata jsonb DEFAULT '{}'::jsonb,
  started_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT cron_job_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.crypto_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  wallet_id uuid,
  transaction_hash text UNIQUE,
  transaction_type text CHECK (transaction_type = ANY (ARRAY['deposit'::text, 'withdrawal'::text, 'purchase'::text, 'swap'::text, 'stake'::text, 'unstake'::text])),
  cryptocurrency text NOT NULL,
  amount numeric NOT NULL,
  usd_value numeric,
  fee_amount numeric,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirming'::text, 'completed'::text, 'failed'::text, 'cancelled'::text])),
  confirmations integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT crypto_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT crypto_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT crypto_transactions_wallet_id_fkey FOREIGN KEY (wallet_id) REFERENCES public.crypto_wallets(id)
);
CREATE TABLE public.crypto_wallets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  wallet_address text NOT NULL,
  blockchain text NOT NULL CHECK (blockchain = ANY (ARRAY['ethereum'::text, 'bitcoin'::text, 'binance_smart_chain'::text, 'polygon'::text, 'solana'::text])),
  wallet_type text CHECK (wallet_type = ANY (ARRAY['hot'::text, 'cold'::text, 'hardware'::text, 'custodial'::text])),
  is_primary boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  balance_cache jsonb,
  last_sync_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT crypto_wallets_pkey PRIMARY KEY (id),
  CONSTRAINT crypto_wallets_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.currency_rates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  from_currency text NOT NULL,
  to_currency text NOT NULL,
  rate numeric NOT NULL,
  source text DEFAULT 'openexchangerates'::text,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT currency_rates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.daily_challenges (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  challenge_date date NOT NULL UNIQUE,
  challenge_type text CHECK (challenge_type = ANY (ARRAY['shopping'::text, 'social'::text, 'content'::text, 'engagement'::text, 'learning'::text])),
  challenge_title text NOT NULL,
  challenge_description text NOT NULL,
  challenge_goal jsonb NOT NULL,
  reward_points integer DEFAULT 0,
  reward_badge uuid,
  difficulty text CHECK (difficulty = ANY (ARRAY['easy'::text, 'medium'::text, 'hard'::text, 'expert'::text])),
  is_active boolean DEFAULT true,
  CONSTRAINT daily_challenges_pkey PRIMARY KEY (id),
  CONSTRAINT daily_challenges_reward_badge_fkey FOREIGN KEY (reward_badge) REFERENCES public.badges(id)
);
CREATE TABLE public.daily_health_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  log_date date NOT NULL,
  weight numeric,
  steps integer,
  calories_consumed integer,
  calories_burned integer,
  water_intake_ml integer,
  sleep_hours numeric,
  mood text CHECK (mood = ANY (ARRAY['excellent'::text, 'good'::text, 'okay'::text, 'bad'::text, 'terrible'::text])),
  notes text,
  CONSTRAINT daily_health_logs_pkey PRIMARY KEY (id),
  CONSTRAINT daily_health_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.dashboard_widgets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  widget_type text NOT NULL CHECK (widget_type = ANY (ARRAY['metric_card'::text, 'line_chart'::text, 'bar_chart'::text, 'pie_chart'::text, 'table'::text, 'funnel'::text, 'heatmap'::text, 'map'::text, 'leaderboard'::text, 'activity_feed'::text])),
  title text NOT NULL,
  config jsonb DEFAULT '{}'::jsonb,
  position_x integer DEFAULT 0,
  position_y integer DEFAULT 0,
  width integer DEFAULT 4,
  height integer DEFAULT 3,
  refresh_interval_seconds integer DEFAULT 300,
  is_visible boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT dashboard_widgets_pkey PRIMARY KEY (id),
  CONSTRAINT dashboard_widgets_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.developer_apps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  developer_id uuid NOT NULL,
  app_name text NOT NULL,
  app_description text,
  app_icon_url text,
  app_website text,
  redirect_uris ARRAY NOT NULL,
  scopes ARRAY DEFAULT ARRAY['read:profile'::text],
  client_id text NOT NULL UNIQUE,
  client_secret_hash text NOT NULL,
  is_verified boolean DEFAULT false,
  is_public boolean DEFAULT false,
  total_installs integer DEFAULT 0,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'suspended'::text, 'revoked'::text])),
  created_at timestamp with time zone DEFAULT now(),
  oauth_app_id uuid,
  CONSTRAINT developer_apps_pkey PRIMARY KEY (id),
  CONSTRAINT developer_apps_developer_id_fkey FOREIGN KEY (developer_id) REFERENCES public.users(id),
  CONSTRAINT developer_apps_oauth_app_id_fkey FOREIGN KEY (oauth_app_id) REFERENCES public.oauth_applications(id)
);
CREATE TABLE public.direct_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sender_id uuid NOT NULL,
  receiver_id uuid NOT NULL,
  message_type text DEFAULT 'text'::text CHECK (message_type = ANY (ARRAY['text'::text, 'image'::text, 'video'::text, 'audio'::text, 'file'::text, 'location'::text, 'sticker'::text, 'gif'::text])),
  content text,
  media_url text,
  is_read boolean DEFAULT false,
  is_deleted_by_sender boolean DEFAULT false,
  is_deleted_by_receiver boolean DEFAULT false,
  reply_to_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  read_at timestamp with time zone,
  CONSTRAINT direct_messages_pkey PRIMARY KEY (id),
  CONSTRAINT direct_messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(id),
  CONSTRAINT direct_messages_receiver_id_fkey FOREIGN KEY (receiver_id) REFERENCES public.users(id),
  CONSTRAINT direct_messages_reply_to_id_fkey FOREIGN KEY (reply_to_id) REFERENCES public.direct_messages(id)
);
CREATE TABLE public.drive_file_shares (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  file_id uuid NOT NULL,
  shared_by uuid NOT NULL,
  shared_with uuid,
  shared_email text,
  permission text DEFAULT 'view'::text CHECK (permission = ANY (ARRAY['view'::text, 'comment'::text, 'edit'::text, 'owner'::text])),
  share_link text UNIQUE,
  link_expires_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT drive_file_shares_pkey PRIMARY KEY (id),
  CONSTRAINT drive_file_shares_shared_with_fkey FOREIGN KEY (shared_with) REFERENCES public.users(id),
  CONSTRAINT drive_file_shares_file_id_fkey FOREIGN KEY (file_id) REFERENCES public.drive_files(id),
  CONSTRAINT drive_file_shares_shared_by_fkey FOREIGN KEY (shared_by) REFERENCES public.users(id)
);
CREATE TABLE public.drive_files (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  org_id uuid,
  parent_folder_id uuid,
  name text NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['file'::text, 'folder'::text, 'shortcut'::text])),
  mime_type text,
  extension text,
  file_url text,
  file_base64 text,
  size_bytes bigint DEFAULT 0,
  is_starred boolean DEFAULT false,
  is_trashed boolean DEFAULT false,
  is_shared boolean DEFAULT false,
  version integer DEFAULT 1,
  checksum text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  trashed_at timestamp with time zone,
  password_protected boolean DEFAULT false,
  expiry_date timestamp with time zone,
  download_count integer DEFAULT 0,
  preview_enabled boolean DEFAULT true,
  ocr_text text,
  ai_summary text,
  CONSTRAINT drive_files_pkey PRIMARY KEY (id),
  CONSTRAINT drive_files_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT drive_files_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.drive_storage_quota (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  total_bytes bigint DEFAULT '5368709120'::bigint,
  used_bytes bigint DEFAULT 0,
  plan text DEFAULT 'free'::text CHECK (plan = ANY (ARRAY['free'::text, 'basic_15gb'::text, 'pro_100gb'::text, 'business_1tb'::text, 'unlimited'::text])),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT drive_storage_quota_pkey PRIMARY KEY (id),
  CONSTRAINT drive_storage_quota_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.email_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recipient_email text NOT NULL,
  recipient_name text,
  recipient_user_id uuid,
  template_id uuid,
  subject text NOT NULL,
  html_body text,
  text_body text,
  variables jsonb DEFAULT '{}'::jsonb,
  status text DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'sending'::text, 'sent'::text, 'failed'::text, 'bounced'::text, 'spam'::text])),
  priority integer DEFAULT 5 CHECK (priority >= 1 AND priority <= 10),
  retry_count integer DEFAULT 0,
  max_retries integer DEFAULT 3,
  scheduled_at timestamp with time zone DEFAULT now(),
  sent_at timestamp with time zone,
  failed_reason text,
  message_id text,
  opened_at timestamp with time zone,
  clicked_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_queue_pkey PRIMARY KEY (id),
  CONSTRAINT email_queue_recipient_user_id_fkey FOREIGN KEY (recipient_user_id) REFERENCES public.users(id),
  CONSTRAINT email_queue_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.email_templates(id)
);
CREATE TABLE public.email_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_name text NOT NULL UNIQUE,
  subject text NOT NULL,
  category text CHECK (category = ANY (ARRAY['welcome'::text, 'verification'::text, 'reset_password'::text, 'purchase_confirm'::text, 'cart_recovery'::text, 'win_back'::text, 'promotion'::text, 'newsletter'::text, 'loyalty_reward'::text, 'referral'::text, 'subscription'::text, 'system'::text])),
  html_body text NOT NULL,
  text_body text,
  variables ARRAY,
  is_active boolean DEFAULT true,
  sent_count integer DEFAULT 0,
  open_rate numeric DEFAULT 0.00,
  click_rate numeric DEFAULT 0.00,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.encryption_keys (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  key_name text NOT NULL UNIQUE,
  key_type text NOT NULL CHECK (key_type = ANY (ARRAY['aes256'::text, 'rsa2048'::text, 'rsa4096'::text, 'ed25519'::text, 'hmac_sha256'::text])),
  purpose text NOT NULL CHECK (purpose = ANY (ARRAY['data_encryption'::text, 'token_signing'::text, 'api_auth'::text, 'backup'::text, 'communication'::text])),
  public_key text,
  key_hash text NOT NULL,
  is_active boolean DEFAULT true,
  rotated_from uuid,
  expires_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  rotated_at timestamp with time zone,
  CONSTRAINT encryption_keys_pkey PRIMARY KEY (id)
);
CREATE TABLE public.error_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  error_type text NOT NULL CHECK (error_type = ANY (ARRAY['client'::text, 'server'::text, 'database'::text, 'api'::text, 'payment'::text, 'auth'::text, 'unknown'::text])),
  error_code text,
  error_message text NOT NULL,
  stack_trace text,
  page_url text,
  request_data jsonb DEFAULT '{}'::jsonb,
  browser text,
  device_type text,
  ip_address inet,
  severity text DEFAULT 'error'::text CHECK (severity = ANY (ARRAY['debug'::text, 'info'::text, 'warning'::text, 'error'::text, 'critical'::text])),
  is_resolved boolean DEFAULT false,
  occurrence_count integer DEFAULT 1,
  first_seen_at timestamp with time zone DEFAULT now(),
  last_seen_at timestamp with time zone DEFAULT now(),
  CONSTRAINT error_logs_pkey PRIMARY KEY (id),
  CONSTRAINT error_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.external_connections (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  service_name text NOT NULL,
  service_type text CHECK (service_type = ANY (ARRAY['calendar'::text, 'email'::text, 'crm'::text, 'accounting'::text, 'analytics'::text, 'shipping'::text, 'payment'::text])),
  access_token_encrypted text,
  refresh_token_encrypted text,
  token_expires_at timestamp with time zone,
  scope ARRAY,
  is_active boolean DEFAULT true,
  last_sync_at timestamp with time zone,
  sync_status text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT external_connections_pkey PRIMARY KEY (id),
  CONSTRAINT external_connections_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.feature_flags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  flag_name text NOT NULL UNIQUE,
  description text,
  is_enabled_globally boolean DEFAULT false,
  enabled_for_segments ARRAY,
  enabled_for_countries ARRAY,
  enabled_for_plans ARRAY,
  rollout_percentage integer DEFAULT 0 CHECK (rollout_percentage >= 0 AND rollout_percentage <= 100),
  start_at timestamp with time zone,
  end_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT feature_flags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.financial_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  report_month date NOT NULL UNIQUE,
  gross_revenue numeric DEFAULT 0,
  net_revenue numeric DEFAULT 0,
  total_refunds numeric DEFAULT 0,
  total_payouts numeric DEFAULT 0,
  affiliate_commissions numeric DEFAULT 0,
  creator_payouts numeric DEFAULT 0,
  platform_fees numeric DEFAULT 0,
  tax_collected numeric DEFAULT 0,
  payment_gateway_fees numeric DEFAULT 0,
  profit_loss numeric DEFAULT 0,
  new_subscribers integer DEFAULT 0,
  churned_subscribers integer DEFAULT 0,
  mrr_start numeric DEFAULT 0,
  mrr_end numeric DEFAULT 0,
  generated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT financial_reports_pkey PRIMARY KEY (id)
);
CREATE TABLE public.flash_sales (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sale_name text NOT NULL,
  description text,
  banner_url text,
  banner_svg text,
  product_ids ARRAY,
  discount_type text NOT NULL CHECK (discount_type = ANY (ARRAY['percent'::text, 'fixed'::text, 'bogo'::text, 'bundle'::text])),
  discount_value numeric,
  max_quantity_per_user integer DEFAULT 1,
  total_quota integer,
  sold_count integer DEFAULT 0,
  start_at timestamp with time zone NOT NULL,
  end_at timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  target_segments ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT flash_sales_pkey PRIMARY KEY (id)
);
CREATE TABLE public.fraud_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  session_id text,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['multiple_accounts'::text, 'card_testing'::text, 'credential_stuffing'::text, 'bot_activity'::text, 'velocity_abuse'::text, 'chargeback_fraud'::text, 'promo_abuse'::text, 'account_takeover'::text, 'payment_fraud'::text, 'fake_review'::text, 'spam'::text, 'identity_theft'::text])),
  risk_score integer DEFAULT 0 CHECK (risk_score >= 0 AND risk_score <= 100),
  ip_address inet,
  device_fingerprint text,
  evidence jsonb DEFAULT '{}'::jsonb,
  status text DEFAULT 'detected'::text CHECK (status = ANY (ARRAY['detected'::text, 'investigating'::text, 'confirmed'::text, 'false_positive'::text, 'resolved'::text])),
  action_taken text,
  reviewed_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  CONSTRAINT fraud_events_pkey PRIMARY KEY (id),
  CONSTRAINT fraud_events_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT fraud_events_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.users(id)
);
CREATE TABLE public.funnel_dropoffs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  funnel_name text NOT NULL,
  dropped_at_step integer NOT NULL,
  reason_detected text,
  session_duration_seconds integer,
  device_type text,
  dropped_at timestamp with time zone DEFAULT now(),
  CONSTRAINT funnel_dropoffs_pkey PRIMARY KEY (id),
  CONSTRAINT funnel_dropoffs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.funnel_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  funnel_name text NOT NULL,
  step_number integer NOT NULL,
  step_name text NOT NULL,
  page_url text,
  event_type text,
  description text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT funnel_steps_pkey PRIMARY KEY (id)
);
CREATE TABLE public.game_achievements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  game_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  icon_url text,
  icon_svg text,
  rarity text DEFAULT 'common'::text CHECK (rarity = ANY (ARRAY['common'::text, 'uncommon'::text, 'rare'::text, 'epic'::text, 'legendary'::text])),
  points integer DEFAULT 10,
  unlock_condition jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT game_achievements_pkey PRIMARY KEY (id),
  CONSTRAINT game_achievements_game_id_fkey FOREIGN KEY (game_id) REFERENCES public.games(id)
);
CREATE TABLE public.game_leaderboards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  game_id uuid NOT NULL,
  user_id uuid NOT NULL,
  score bigint DEFAULT 0,
  rank integer,
  level integer DEFAULT 1,
  season text,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT game_leaderboards_pkey PRIMARY KEY (id),
  CONSTRAINT game_leaderboards_game_id_fkey FOREIGN KEY (game_id) REFERENCES public.games(id),
  CONSTRAINT game_leaderboards_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.game_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  game_id uuid NOT NULL,
  started_at timestamp with time zone DEFAULT now(),
  ended_at timestamp with time zone,
  duration_minutes integer DEFAULT 0,
  score bigint DEFAULT 0,
  device_type text,
  CONSTRAINT game_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT game_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT game_sessions_game_id_fkey FOREIGN KEY (game_id) REFERENCES public.games(id)
);
CREATE TABLE public.games (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  game_name text NOT NULL,
  slug text NOT NULL UNIQUE,
  developer text,
  publisher text,
  description text,
  long_description text,
  thumbnail_url text,
  banner_url text,
  trailer_url text,
  genre ARRAY,
  tags ARRAY,
  platform ARRAY CHECK (platform <@ ARRAY['web'::text, 'android'::text, 'ios'::text, 'windows'::text, 'mac'::text, 'linux'::text]),
  game_type text CHECK (game_type = ANY (ARRAY['single_player'::text, 'multiplayer'::text, 'mmo'::text, 'battle_royale'::text, 'puzzle'::text, 'casual'::text, 'strategy'::text, 'rpg'::text, 'sports'::text])),
  age_rating text DEFAULT 'E'::text,
  price numeric DEFAULT 0.00,
  pricing_type text DEFAULT 'free'::text CHECK (pricing_type = ANY (ARRAY['free'::text, 'paid'::text, 'freemium'::text, 'subscription'::text])),
  file_size_mb numeric,
  rating numeric DEFAULT 0.00,
  review_count integer DEFAULT 0,
  player_count integer DEFAULT 0,
  is_featured boolean DEFAULT false,
  is_active boolean DEFAULT true,
  launched_at date,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT games_pkey PRIMARY KEY (id)
);
CREATE TABLE public.geo_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  date date NOT NULL,
  country text NOT NULL,
  city text,
  user_count integer DEFAULT 0,
  new_users integer DEFAULT 0,
  revenue numeric DEFAULT 0,
  orders integer DEFAULT 0,
  avg_order_value numeric DEFAULT 0,
  CONSTRAINT geo_analytics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.group_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  group_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text DEFAULT 'member'::text CHECK (role = ANY (ARRAY['owner'::text, 'admin'::text, 'moderator'::text, 'member'::text])),
  joined_at timestamp with time zone DEFAULT now(),
  invited_by uuid,
  CONSTRAINT group_members_pkey PRIMARY KEY (id),
  CONSTRAINT group_members_group_id_fkey FOREIGN KEY (group_id) REFERENCES public.user_groups(id),
  CONSTRAINT group_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT group_members_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.users(id)
);
CREATE TABLE public.hashtag_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  hashtag_id uuid NOT NULL,
  entity_type text NOT NULL CHECK (entity_type = ANY (ARRAY['post'::text, 'media'::text, 'product'::text, 'story'::text])),
  entity_id text NOT NULL,
  used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hashtag_usage_pkey PRIMARY KEY (id),
  CONSTRAINT hashtag_usage_hashtag_id_fkey FOREIGN KEY (hashtag_id) REFERENCES public.hashtags(id)
);
CREATE TABLE public.hashtags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tag text NOT NULL UNIQUE,
  use_count integer DEFAULT 0,
  trending_score numeric DEFAULT 0,
  is_banned boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hashtags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.health_goals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  goal_type text CHECK (goal_type = ANY (ARRAY['weight_loss'::text, 'weight_gain'::text, 'fitness'::text, 'nutrition'::text, 'sleep'::text, 'mental_health'::text])),
  target_value numeric,
  current_value numeric,
  unit text,
  start_date date DEFAULT CURRENT_DATE,
  target_date date,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT health_goals_pkey PRIMARY KEY (id),
  CONSTRAINT health_goals_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.ip_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ip_address inet NOT NULL,
  ip_range cidr,
  rule_type text NOT NULL CHECK (rule_type = ANY (ARRAY['blacklist'::text, 'whitelist'::text, 'throttle'::text, 'captcha'::text])),
  reason text,
  country text,
  threat_score integer DEFAULT 0 CHECK (threat_score >= 0 AND threat_score <= 100),
  is_active boolean DEFAULT true,
  expires_at timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ip_rules_pkey PRIMARY KEY (id),
  CONSTRAINT ip_rules_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.kb_articles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  title text NOT NULL,
  slug text NOT NULL UNIQUE,
  content text NOT NULL,
  category text,
  tags ARRAY,
  is_published boolean DEFAULT true,
  view_count integer DEFAULT 0,
  helpful_count integer DEFAULT 0,
  not_helpful_count integer DEFAULT 0,
  author_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT kb_articles_pkey PRIMARY KEY (id),
  CONSTRAINT kb_articles_author_id_fkey FOREIGN KEY (author_id) REFERENCES public.users(id)
);
CREATE TABLE public.landing_pages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  slug text NOT NULL UNIQUE,
  title text NOT NULL,
  meta_title text,
  meta_description text,
  og_image_url text,
  sections jsonb DEFAULT '[]'::jsonb,
  styles jsonb DEFAULT '{}'::jsonb,
  scripts text,
  is_published boolean DEFAULT false,
  ab_test_id uuid,
  view_count integer DEFAULT 0,
  conversion_count integer DEFAULT 0,
  conversion_rate numeric DEFAULT 0,
  target_segments ARRAY,
  published_at timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT landing_pages_pkey PRIMARY KEY (id),
  CONSTRAINT landing_pages_ab_test_id_fkey FOREIGN KEY (ab_test_id) REFERENCES public.ab_test_configs(id),
  CONSTRAINT landing_pages_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.languages (
  code text NOT NULL,
  name text NOT NULL,
  native_name text,
  rtl boolean DEFAULT false,
  is_active boolean DEFAULT true,
  completion_percent integer DEFAULT 0,
  CONSTRAINT languages_pkey PRIMARY KEY (code)
);
CREATE TABLE public.mail_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  email_address text NOT NULL UNIQUE,
  display_name text,
  is_active boolean DEFAULT true,
  storage_used_mb numeric DEFAULT 0,
  storage_limit_mb numeric DEFAULT 15360,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mail_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT mail_accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.mail_attachments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  message_id uuid NOT NULL,
  file_name text NOT NULL,
  file_url text,
  mime_type text,
  size_bytes bigint DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mail_attachments_pkey PRIMARY KEY (id),
  CONSTRAINT mail_attachments_message_id_fkey FOREIGN KEY (message_id) REFERENCES public.mail_messages(id)
);
CREATE TABLE public.mail_contacts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  email text NOT NULL,
  phone text,
  company text,
  avatar_url text,
  is_favorite boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mail_contacts_pkey PRIMARY KEY (id),
  CONSTRAINT mail_contacts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.mail_folders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  type text DEFAULT 'custom'::text CHECK (type = ANY (ARRAY['inbox'::text, 'sent'::text, 'drafts'::text, 'trash'::text, 'spam'::text, 'starred'::text, 'custom'::text])),
  color text,
  icon text,
  unread_count integer DEFAULT 0,
  total_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mail_folders_pkey PRIMARY KEY (id),
  CONSTRAINT mail_folders_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.mail_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sender_id uuid,
  sender_email text NOT NULL,
  sender_name text,
  folder_id uuid,
  subject text,
  body_html text,
  body_text text,
  is_read boolean DEFAULT false,
  is_starred boolean DEFAULT false,
  is_draft boolean DEFAULT false,
  has_attachments boolean DEFAULT false,
  thread_id uuid,
  reply_to_id uuid,
  sent_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mail_messages_pkey PRIMARY KEY (id),
  CONSTRAINT mail_messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(id),
  CONSTRAINT mail_messages_folder_id_fkey FOREIGN KEY (folder_id) REFERENCES public.mail_folders(id),
  CONSTRAINT mail_messages_reply_to_id_fkey FOREIGN KEY (reply_to_id) REFERENCES public.mail_messages(id)
);
CREATE TABLE public.mail_recipients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  message_id uuid NOT NULL,
  user_id uuid,
  email text NOT NULL,
  name text,
  type text DEFAULT 'to'::text CHECK (type = ANY (ARRAY['to'::text, 'cc'::text, 'bcc'::text])),
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  CONSTRAINT mail_recipients_pkey PRIMARY KEY (id),
  CONSTRAINT mail_recipients_message_id_fkey FOREIGN KEY (message_id) REFERENCES public.mail_messages(id),
  CONSTRAINT mail_recipients_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.map_places (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  type text CHECK (type = ANY (ARRAY['business'::text, 'restaurant'::text, 'hospital'::text, 'school'::text, 'shop'::text, 'park'::text, 'landmark'::text, 'other'::text])),
  address text,
  city text,
  country text,
  latitude numeric,
  longitude numeric,
  phone text,
  website text,
  rating numeric DEFAULT 0,
  review_count integer DEFAULT 0,
  is_verified boolean DEFAULT false,
  opening_hours jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT map_places_pkey PRIMARY KEY (id)
);
CREATE TABLE public.media_assets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  uploader_id uuid,
  original_filename text NOT NULL,
  stored_filename text NOT NULL UNIQUE,
  file_type text NOT NULL CHECK (file_type = ANY (ARRAY['image'::text, 'video'::text, 'audio'::text, 'document'::text, 'font'::text, 'other'::text])),
  mime_type text,
  size_bytes bigint DEFAULT 0,
  width integer,
  height integer,
  duration_seconds integer,
  cdn_url text,
  thumbnail_url text,
  alt_text text,
  tags ARRAY,
  folder text DEFAULT '/'::text,
  is_public boolean DEFAULT true,
  download_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT media_assets_pkey PRIMARY KEY (id),
  CONSTRAINT media_assets_uploader_id_fkey FOREIGN KEY (uploader_id) REFERENCES public.users(id)
);
CREATE TABLE public.media_comments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  media_id uuid NOT NULL,
  user_id uuid NOT NULL,
  parent_id uuid,
  content text NOT NULL,
  like_count integer DEFAULT 0,
  is_pinned boolean DEFAULT false,
  is_approved boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT media_comments_pkey PRIMARY KEY (id),
  CONSTRAINT media_comments_media_id_fkey FOREIGN KEY (media_id) REFERENCES public.media_items(id),
  CONSTRAINT media_comments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT media_comments_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.media_comments(id)
);
CREATE TABLE public.media_creator_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  channel_name text NOT NULL UNIQUE,
  channel_handle text UNIQUE,
  channel_description text,
  channel_banner_url text,
  channel_logo_url text,
  channel_logo_svg text,
  subscriber_count integer DEFAULT 0,
  total_views bigint DEFAULT 0,
  total_videos integer DEFAULT 0,
  is_verified boolean DEFAULT false,
  is_monetized boolean DEFAULT false,
  revenue_share_percent numeric DEFAULT 70.00,
  total_earned numeric DEFAULT 0.00,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT media_creator_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT media_creator_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.media_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  creator_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['video'::text, 'audio'::text, 'podcast'::text, 'live_stream'::text, 'short'::text, 'movie'::text, 'series_episode'::text, 'music_track'::text, 'album'::text, 'audiobook'::text, 'ebook'::text])),
  title text NOT NULL,
  slug text NOT NULL UNIQUE,
  description text,
  thumbnail_url text,
  media_url text,
  duration_seconds integer DEFAULT 0,
  file_size_mb numeric,
  resolution text,
  quality_options jsonb DEFAULT '{}'::jsonb,
  language text DEFAULT 'bn'::text,
  subtitles jsonb DEFAULT '[]'::jsonb,
  category text,
  tags ARRAY,
  genre ARRAY,
  age_rating text DEFAULT 'G'::text CHECK (age_rating = ANY (ARRAY['G'::text, 'PG'::text, 'PG-13'::text, 'R'::text, 'NC-17'::text])),
  is_premium boolean DEFAULT false,
  is_live boolean DEFAULT false,
  view_count bigint DEFAULT 0,
  like_count integer DEFAULT 0,
  dislike_count integer DEFAULT 0,
  comment_count integer DEFAULT 0,
  share_count integer DEFAULT 0,
  save_count integer DEFAULT 0,
  status text DEFAULT 'published'::text CHECK (status = ANY (ARRAY['draft'::text, 'processing'::text, 'published'::text, 'archived'::text, 'removed'::text])),
  published_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  content_warning text,
  is_monetized boolean DEFAULT false,
  revenue_earned numeric DEFAULT 0,
  download_enabled boolean DEFAULT false,
  download_count integer DEFAULT 0,
  embed_enabled boolean DEFAULT true,
  chapters jsonb DEFAULT '[]'::jsonb,
  CONSTRAINT media_items_pkey PRIMARY KEY (id),
  CONSTRAINT media_items_creator_id_fkey FOREIGN KEY (creator_id) REFERENCES public.users(id)
);
CREATE TABLE public.media_playlist_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  playlist_id uuid NOT NULL,
  media_id uuid NOT NULL,
  position integer DEFAULT 0,
  added_at timestamp with time zone DEFAULT now(),
  CONSTRAINT media_playlist_items_pkey PRIMARY KEY (id),
  CONSTRAINT media_playlist_items_media_id_fkey FOREIGN KEY (media_id) REFERENCES public.media_items(id),
  CONSTRAINT media_playlist_items_playlist_id_fkey FOREIGN KEY (playlist_id) REFERENCES public.media_playlists(id)
);
CREATE TABLE public.media_playlists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  thumbnail_url text,
  is_public boolean DEFAULT false,
  item_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT media_playlists_pkey PRIMARY KEY (id),
  CONSTRAINT media_playlists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.media_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  subscriber_id uuid NOT NULL,
  channel_id uuid NOT NULL,
  notify_new_content boolean DEFAULT true,
  subscribed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT media_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT media_subscriptions_subscriber_id_fkey FOREIGN KEY (subscriber_id) REFERENCES public.users(id),
  CONSTRAINT media_subscriptions_channel_id_fkey FOREIGN KEY (channel_id) REFERENCES public.users(id)
);
CREATE TABLE public.media_watch_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  media_id uuid NOT NULL,
  watched_seconds integer DEFAULT 0,
  total_seconds integer DEFAULT 0,
  completion_percent numeric DEFAULT 0,
  is_completed boolean DEFAULT false,
  last_watched_at timestamp with time zone DEFAULT now(),
  device_type text,
  CONSTRAINT media_watch_history_pkey PRIMARY KEY (id),
  CONSTRAINT media_watch_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT media_watch_history_media_id_fkey FOREIGN KEY (media_id) REFERENCES public.media_items(id)
);
CREATE TABLE public.micro_conversions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  conversion_type text NOT NULL CHECK (conversion_type = ANY (ARRAY['email_signup'::text, 'profile_complete'::text, 'first_search'::text, 'first_product_view'::text, 'first_add_to_cart'::text, 'first_wishlist'::text, 'account_verified'::text, 'first_share'::text, 'first_review'::text, 'newsletter_signup'::text, 'app_download'::text, 'notification_enabled'::text])),
  value_score integer DEFAULT 1,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT micro_conversions_pkey PRIMARY KEY (id),
  CONSTRAINT micro_conversions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.note_collaborators (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  note_id uuid NOT NULL,
  user_id uuid NOT NULL,
  permission text DEFAULT 'view'::text CHECK (permission = ANY (ARRAY['view'::text, 'comment'::text, 'edit'::text])),
  added_at timestamp with time zone DEFAULT now(),
  CONSTRAINT note_collaborators_pkey PRIMARY KEY (id),
  CONSTRAINT note_collaborators_note_id_fkey FOREIGN KEY (note_id) REFERENCES public.user_notes(id),
  CONSTRAINT note_collaborators_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.notification_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  category text NOT NULL,
  push_enabled boolean DEFAULT true,
  email_enabled boolean DEFAULT true,
  sms_enabled boolean DEFAULT false,
  whatsapp_enabled boolean DEFAULT false,
  in_app_enabled boolean DEFAULT true,
  quiet_hours_start time without time zone,
  quiet_hours_end time without time zone,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notification_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT notification_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.oauth_access_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  app_id uuid NOT NULL,
  user_id uuid NOT NULL,
  authorization_id uuid,
  access_token text NOT NULL DEFAULT encode(gen_random_bytes(32), 'hex'::text) UNIQUE,
  refresh_token text DEFAULT encode(gen_random_bytes(32), 'hex'::text) UNIQUE,
  token_type text DEFAULT 'Bearer'::text,
  scopes ARRAY NOT NULL,
  is_active boolean DEFAULT true,
  revoked_at timestamp with time zone,
  ip_address inet,
  device_info text,
  created_at timestamp with time zone DEFAULT now(),
  access_token_expires_at timestamp with time zone DEFAULT (now() + '01:00:00'::interval),
  refresh_token_expires_at timestamp with time zone DEFAULT (now() + '30 days'::interval),
  last_used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT oauth_access_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT oauth_access_tokens_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.oauth_applications(id),
  CONSTRAINT oauth_access_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT oauth_access_tokens_authorization_id_fkey FOREIGN KEY (authorization_id) REFERENCES public.oauth_authorizations(id)
);
CREATE TABLE public.oauth_applications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  developer_id uuid NOT NULL,
  app_name text NOT NULL,
  app_description text,
  app_logo_url text,
  app_logo_svg text,
  app_website text NOT NULL,
  app_privacy_policy_url text,
  app_terms_url text,
  app_category text CHECK (app_category = ANY (ARRAY['social'::text, 'ecommerce'::text, 'productivity'::text, 'education'::text, 'health'::text, 'finance'::text, 'entertainment'::text, 'news'::text, 'tools'::text, 'other'::text])),
  client_id text NOT NULL DEFAULT ('zpria_'::text || encode(gen_random_bytes(16), 'hex'::text)) UNIQUE,
  client_secret_hash text NOT NULL,
  client_secret_prefix text NOT NULL,
  redirect_uris ARRAY NOT NULL,
  allowed_origins ARRAY DEFAULT ARRAY[]::text[],
  allowed_scopes ARRAY DEFAULT ARRAY['openid'::text, 'profile'::text, 'email'::text],
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'active'::text, 'suspended'::text, 'revoked'::text])),
  is_verified boolean DEFAULT false,
  is_trusted boolean DEFAULT false,
  verification_notes text,
  total_users integer DEFAULT 0,
  daily_active_users integer DEFAULT 0,
  monthly_active_users integer DEFAULT 0,
  approved_at timestamp with time zone,
  approved_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT oauth_applications_pkey PRIMARY KEY (id),
  CONSTRAINT oauth_applications_developer_id_fkey FOREIGN KEY (developer_id) REFERENCES public.users(id),
  CONSTRAINT oauth_applications_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id)
);
CREATE TABLE public.oauth_authorization_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  app_id uuid NOT NULL,
  user_id uuid NOT NULL,
  authorization_id uuid,
  code text NOT NULL DEFAULT encode(gen_random_bytes(32), 'hex'::text) UNIQUE,
  code_challenge text,
  code_challenge_method text DEFAULT 'S256'::text,
  requested_scopes ARRAY NOT NULL,
  redirect_uri text NOT NULL,
  state text,
  is_used boolean DEFAULT false,
  used_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '00:10:00'::interval),
  CONSTRAINT oauth_authorization_codes_pkey PRIMARY KEY (id),
  CONSTRAINT oauth_authorization_codes_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.oauth_applications(id),
  CONSTRAINT oauth_authorization_codes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT oauth_authorization_codes_authorization_id_fkey FOREIGN KEY (authorization_id) REFERENCES public.oauth_authorizations(id)
);
CREATE TABLE public.oauth_authorizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_id uuid NOT NULL,
  granted_scopes ARRAY NOT NULL,
  denied_scopes ARRAY DEFAULT ARRAY[]::text[],
  is_active boolean DEFAULT true,
  revoked_at timestamp with time zone,
  revoke_reason text,
  last_used_at timestamp with time zone,
  use_count integer DEFAULT 0,
  consented_at timestamp with time zone DEFAULT now(),
  consent_ip inet,
  consent_device text,
  CONSTRAINT oauth_authorizations_pkey PRIMARY KEY (id),
  CONSTRAINT oauth_authorizations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT oauth_authorizations_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.oauth_applications(id)
);
CREATE TABLE public.oauth_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  app_id uuid NOT NULL,
  user_id uuid NOT NULL,
  code text NOT NULL UNIQUE,
  scopes ARRAY,
  redirect_uri text NOT NULL,
  is_used boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '00:10:00'::interval),
  CONSTRAINT oauth_codes_pkey PRIMARY KEY (id),
  CONSTRAINT oauth_codes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT oauth_codes_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.oauth_applications(id)
);
CREATE TABLE public.oauth_scopes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  scope_name text NOT NULL UNIQUE,
  display_name text NOT NULL,
  description text NOT NULL,
  icon text,
  category text DEFAULT 'basic'::text CHECK (category = ANY (ARRAY['basic'::text, 'personal'::text, 'activity'::text, 'financial'::text, 'sensitive'::text])),
  is_default boolean DEFAULT false,
  requires_approval boolean DEFAULT false,
  is_active boolean DEFAULT true,
  CONSTRAINT oauth_scopes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.oauth_token_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  token_id uuid,
  app_id uuid,
  user_id uuid,
  action text NOT NULL CHECK (action = ANY (ARRAY['authorize'::text, 'token_issued'::text, 'token_used'::text, 'token_refreshed'::text, 'token_revoked'::text, 'scope_requested'::text, 'access_denied'::text, 'error'::text])),
  endpoint text,
  ip_address inet,
  user_agent text,
  scopes_used ARRAY,
  success boolean DEFAULT true,
  error_message text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT oauth_token_logs_pkey PRIMARY KEY (id),
  CONSTRAINT oauth_token_logs_token_id_fkey FOREIGN KEY (token_id) REFERENCES public.oauth_access_tokens(id),
  CONSTRAINT oauth_token_logs_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.oauth_applications(id),
  CONSTRAINT oauth_token_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.order_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id text NOT NULL,
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  product_name text,
  product_image_url text,
  variant_id uuid,
  sku text,
  quantity integer NOT NULL DEFAULT 1,
  unit_price numeric NOT NULL,
  discount_amount numeric DEFAULT 0,
  tax_amount numeric DEFAULT 0,
  total_price numeric NOT NULL,
  is_gift boolean DEFAULT false,
  gift_message text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'shipped'::text, 'delivered'::text, 'returned'::text, 'cancelled'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT order_items_pkey PRIMARY KEY (id),
  CONSTRAINT order_items_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.order_shipments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id text NOT NULL,
  user_id uuid NOT NULL,
  address_id uuid,
  carrier text,
  tracking_number text,
  tracking_url text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'picked_up'::text, 'in_transit'::text, 'out_for_delivery'::text, 'delivered'::text, 'failed'::text, 'returned'::text, 'cancelled'::text])),
  estimated_delivery date,
  delivered_at timestamp with time zone,
  shipping_cost numeric DEFAULT 0.00,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT order_shipments_pkey PRIMARY KEY (id),
  CONSTRAINT order_shipments_address_id_fkey FOREIGN KEY (address_id) REFERENCES public.user_addresses(id),
  CONSTRAINT order_shipments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.organization_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  org_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text DEFAULT 'member'::text CHECK (role = ANY (ARRAY['owner'::text, 'admin'::text, 'member'::text, 'viewer'::text])),
  invited_by uuid,
  joined_at timestamp with time zone DEFAULT now(),
  CONSTRAINT organization_members_pkey PRIMARY KEY (id),
  CONSTRAINT organization_members_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id),
  CONSTRAINT organization_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT organization_members_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.users(id)
);
CREATE TABLE public.organizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  owner_id uuid NOT NULL,
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  logo_url text,
  logo_svg text,
  industry text,
  size text CHECK (size = ANY (ARRAY['1'::text, '2-10'::text, '11-50'::text, '51-200'::text, '201-500'::text, '500+'::text])),
  country text,
  website text,
  plan text DEFAULT 'free'::text CHECK (plan = ANY (ARRAY['free'::text, 'starter'::text, 'pro'::text, 'enterprise'::text])),
  max_members integer DEFAULT 5,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  tax_id text,
  registration_number text,
  founded_year integer,
  employee_count integer,
  description text,
  social_links jsonb DEFAULT '{}'::jsonb,
  verified_at timestamp with time zone,
  is_verified boolean DEFAULT false,
  CONSTRAINT organizations_pkey PRIMARY KEY (id),
  CONSTRAINT organizations_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.users(id)
);
CREATE TABLE public.otp_verifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL,
  otp_code text NOT NULL CHECK (length(otp_code) = 8 AND otp_code ~ '^[0-9]{8}$'::text),
  purpose text NOT NULL CHECK (purpose = ANY (ARRAY['registration'::text, 'password_reset'::text, 'email_verification'::text, 'mobile_verification'::text])),
  is_used boolean NOT NULL DEFAULT false,
  attempts integer NOT NULL DEFAULT 0 CHECK (attempts <= 3),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone NOT NULL DEFAULT (now() + '00:10:00'::interval),
  verified_at timestamp with time zone,
  CONSTRAINT otp_verifications_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payment_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  order_id text,
  invoice_id uuid,
  gateway text NOT NULL CHECK (gateway = ANY (ARRAY['bkash'::text, 'nagad'::text, 'rocket'::text, 'sslcommerz'::text, 'stripe'::text, 'paypal'::text, 'manual'::text, 'wallet'::text])),
  gateway_transaction_id text UNIQUE,
  amount numeric NOT NULL,
  currency text DEFAULT 'BDT'::text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'refunded'::text, 'cancelled'::text, 'disputed'::text])),
  payment_method text,
  gateway_response jsonb DEFAULT '{}'::jsonb,
  ip_address inet,
  initiated_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  refunded_at timestamp with time zone,
  refund_reason text,
  CONSTRAINT payment_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT payment_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT payment_transactions_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES public.user_invoices(id)
);
CREATE TABLE public.payout_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  payout_type text NOT NULL CHECK (payout_type = ANY (ARRAY['affiliate'::text, 'creator'::text, 'wallet_withdrawal'::text, 'refund'::text, 'loyalty_cash'::text])),
  amount numeric NOT NULL,
  currency text DEFAULT 'BDT'::text,
  bank_account_id uuid,
  payment_method text,
  payment_account text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'rejected'::text, 'cancelled'::text])),
  reference_number text UNIQUE,
  admin_notes text,
  processed_by uuid,
  requested_at timestamp with time zone DEFAULT now(),
  processed_at timestamp with time zone,
  CONSTRAINT payout_requests_pkey PRIMARY KEY (id),
  CONSTRAINT payout_requests_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT payout_requests_bank_account_id_fkey FOREIGN KEY (bank_account_id) REFERENCES public.bank_accounts(id),
  CONSTRAINT payout_requests_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES public.users(id)
);
CREATE TABLE public.pending_registrations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  username text NOT NULL UNIQUE CHECK (username ~ '^[a-z0-9._]{8,20}$'::text),
  login_id text NOT NULL UNIQUE CHECK (login_id ~* '^[a-z0-9._]+@prigod\.com$'::text),
  password_hash text NOT NULL CHECK (length(password_hash) = 64),
  first_name text NOT NULL,
  last_name text NOT NULL,
  email text NOT NULL UNIQUE,
  mobile text,
  address text NOT NULL,
  dob date NOT NULL,
  gender text NOT NULL,
  otp_sent boolean NOT NULL DEFAULT false,
  otp_verified boolean NOT NULL DEFAULT false,
  expires_at timestamp with time zone NOT NULL DEFAULT (now() + '00:30:00'::interval),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT pending_registrations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.platform_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  date date NOT NULL UNIQUE,
  total_users integer DEFAULT 0,
  new_users integer DEFAULT 0,
  active_users integer DEFAULT 0,
  churned_users integer DEFAULT 0,
  total_sessions integer DEFAULT 0,
  total_revenue numeric DEFAULT 0.00,
  total_orders integer DEFAULT 0,
  avg_order_value numeric DEFAULT 0.00,
  ads_impressions integer DEFAULT 0,
  ads_clicks integer DEFAULT 0,
  ads_revenue numeric DEFAULT 0.00,
  top_product text,
  top_category text,
  top_country text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT platform_analytics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.platform_announcements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL CHECK (type = ANY (ARRAY['feature'::text, 'maintenance'::text, 'incident'::text, 'update'::text, 'promotion'::text, 'security'::text])),
  title text NOT NULL,
  content text NOT NULL,
  severity text DEFAULT 'info'::text CHECK (severity = ANY (ARRAY['info'::text, 'warning'::text, 'critical'::text, 'success'::text])),
  target_segments ARRAY,
  target_countries ARRAY,
  show_banner boolean DEFAULT false,
  banner_color text DEFAULT '#6366f1'::text,
  is_active boolean DEFAULT true,
  starts_at timestamp with time zone DEFAULT now(),
  ends_at timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT platform_announcements_pkey PRIMARY KEY (id),
  CONSTRAINT platform_announcements_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.platform_config (
  key text NOT NULL,
  value text,
  value_json jsonb,
  description text,
  is_public boolean DEFAULT false,
  updated_by uuid,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT platform_config_pkey PRIMARY KEY (key),
  CONSTRAINT platform_config_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(id)
);
CREATE TABLE public.platform_metrics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  metric_name text NOT NULL,
  metric_value numeric NOT NULL,
  metric_unit text,
  tags jsonb DEFAULT '{}'::jsonb,
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT platform_metrics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.podcast_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  episode_id text NOT NULL,
  progress_seconds integer DEFAULT 0,
  duration_seconds integer,
  is_completed boolean DEFAULT false,
  playback_speed numeric DEFAULT 1.0,
  last_played_at timestamp with time zone DEFAULT now(),
  CONSTRAINT podcast_progress_pkey PRIMARY KEY (id),
  CONSTRAINT podcast_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.podcast_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  podcast_id text NOT NULL,
  auto_download boolean DEFAULT false,
  notification_enabled boolean DEFAULT true,
  subscribed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT podcast_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT podcast_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.price_alerts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  target_price numeric NOT NULL,
  current_price numeric,
  alert_triggered boolean DEFAULT false,
  alert_sent_at timestamp with time zone,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT price_alerts_pkey PRIMARY KEY (id),
  CONSTRAINT price_alerts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.product_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id text NOT NULL,
  date date NOT NULL,
  views integer DEFAULT 0,
  unique_viewers integer DEFAULT 0,
  add_to_cart_count integer DEFAULT 0,
  wishlist_count integer DEFAULT 0,
  purchase_count integer DEFAULT 0,
  revenue numeric DEFAULT 0,
  avg_rating numeric DEFAULT 0,
  review_count integer DEFAULT 0,
  return_rate numeric DEFAULT 0,
  CONSTRAINT product_analytics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_bundles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  bundle_name text NOT NULL,
  description text,
  product_ids ARRAY NOT NULL,
  original_price numeric,
  bundle_price numeric NOT NULL,
  discount_percent numeric,
  is_active boolean DEFAULT true,
  valid_from date,
  valid_until date,
  purchase_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_bundles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  description text,
  parent_id uuid,
  icon_url text,
  icon_svg text,
  banner_url text,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  product_count integer DEFAULT 0,
  seo_title text,
  seo_description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_categories_pkey PRIMARY KEY (id),
  CONSTRAINT product_categories_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.product_categories(id)
);
CREATE TABLE public.product_category_map (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id text NOT NULL,
  category_id uuid NOT NULL,
  is_primary boolean DEFAULT false,
  CONSTRAINT product_category_map_pkey PRIMARY KEY (id),
  CONSTRAINT product_category_map_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.product_categories(id)
);
CREATE TABLE public.product_inventory (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id text NOT NULL UNIQUE,
  variant_id uuid,
  stock_type text DEFAULT 'unlimited'::text CHECK (stock_type = ANY (ARRAY['unlimited'::text, 'limited'::text, 'digital'::text, 'pre_order'::text])),
  total_stock integer DEFAULT '-1'::integer,
  reserved_stock integer DEFAULT 0,
  available_stock integer DEFAULT '-1'::integer,
  low_stock_threshold integer DEFAULT 10,
  is_in_stock boolean DEFAULT true,
  restock_date date,
  last_restocked_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_inventory_pkey PRIMARY KEY (id),
  CONSTRAINT product_inventory_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(id)
);
CREATE TABLE public.product_price_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id text NOT NULL,
  old_price numeric,
  new_price numeric NOT NULL,
  change_reason text CHECK (change_reason = ANY (ARRAY['manual'::text, 'sale'::text, 'restock'::text, 'inflation'::text, 'promotion'::text, 'bundle'::text])),
  changed_by uuid,
  effective_from timestamp with time zone DEFAULT now(),
  effective_until timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_price_history_pkey PRIMARY KEY (id),
  CONSTRAINT product_price_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.users(id)
);
CREATE TABLE public.product_questions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id text NOT NULL,
  user_id uuid NOT NULL,
  question text NOT NULL,
  answer text,
  answered_by uuid,
  answered_at timestamp with time zone,
  is_approved boolean DEFAULT true,
  helpful_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_questions_pkey PRIMARY KEY (id),
  CONSTRAINT product_questions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT product_questions_answered_by_fkey FOREIGN KEY (answered_by) REFERENCES public.users(id)
);
CREATE TABLE public.product_recommendations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  recommendation_type text NOT NULL CHECK (recommendation_type = ANY (ARRAY['interest_based'::text, 'collaborative'::text, 'trending'::text, 'new_arrival'::text, 'price_drop'::text, 'similar_to_viewed'::text, 'frequently_bought_together'::text, 'segment_based'::text, 'ai_generated'::text])),
  score numeric DEFAULT 0.0000,
  reason text,
  is_shown boolean DEFAULT false,
  is_clicked boolean DEFAULT false,
  is_purchased boolean DEFAULT false,
  generated_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '24:00:00'::interval),
  CONSTRAINT product_recommendations_pkey PRIMARY KEY (id),
  CONSTRAINT product_recommendations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.product_tags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tag_name text NOT NULL UNIQUE,
  tag_slug text NOT NULL UNIQUE,
  tag_color text DEFAULT '#6366f1'::text,
  use_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_tags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_types (
  type_id integer NOT NULL DEFAULT nextval('product_types_type_id_seq'::regclass),
  type_name character varying NOT NULL UNIQUE,
  type_description text,
  type_icon character varying,
  type_question character varying,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_types_pkey PRIMARY KEY (type_id)
);
CREATE TABLE public.product_variants (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id text NOT NULL,
  variant_name text NOT NULL,
  variant_type text NOT NULL CHECK (variant_type = ANY (ARRAY['size'::text, 'color'::text, 'storage'::text, 'plan'::text, 'duration'::text, 'other'::text])),
  variant_value text NOT NULL,
  additional_price numeric DEFAULT 0.00,
  stock_count integer DEFAULT '-1'::integer,
  sku text UNIQUE,
  is_active boolean DEFAULT true,
  display_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_variants_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_waitlists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  product_name text,
  notify_email boolean DEFAULT true,
  notify_push boolean DEFAULT true,
  notified_at timestamp with time zone,
  position integer,
  joined_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_waitlists_pkey PRIMARY KEY (id),
  CONSTRAINT product_waitlists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.promo_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  description text,
  discount_type text NOT NULL CHECK (discount_type = ANY (ARRAY['percent'::text, 'fixed'::text, 'free_shipping'::text, 'bogo'::text])),
  discount_value numeric NOT NULL,
  min_order_amount numeric DEFAULT 0,
  max_discount_cap numeric,
  usage_limit integer,
  usage_count integer DEFAULT 0,
  per_user_limit integer DEFAULT 1,
  applicable_products ARRAY,
  applicable_categories ARRAY,
  applicable_segments ARRAY,
  valid_from timestamp with time zone DEFAULT now(),
  valid_until timestamp with time zone,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT promo_codes_pkey PRIMARY KEY (id),
  CONSTRAINT promo_codes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.rate_limit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  ip_address inet NOT NULL,
  endpoint text NOT NULL,
  request_count integer DEFAULT 1,
  window_start timestamp with time zone DEFAULT now(),
  window_end timestamp with time zone DEFAULT (now() + '01:00:00'::interval),
  is_blocked boolean DEFAULT false,
  blocked_until timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT rate_limit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT rate_limit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.reactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  entity_type text NOT NULL CHECK (entity_type = ANY (ARRAY['post'::text, 'comment'::text, 'media'::text, 'review'::text, 'story'::text, 'message'::text])),
  entity_id text NOT NULL,
  reaction_type text NOT NULL CHECK (reaction_type = ANY (ARRAY['like'::text, 'love'::text, 'haha'::text, 'wow'::text, 'sad'::text, 'angry'::text, 'fire'::text, 'clap'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT reactions_pkey PRIMARY KEY (id),
  CONSTRAINT reactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.reading_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  content_id uuid NOT NULL,
  content_type text CHECK (content_type = ANY (ARRAY['blog'::text, 'article'::text, 'ebook'::text, 'guide'::text])),
  progress_percent integer DEFAULT 0 CHECK (progress_percent >= 0 AND progress_percent <= 100),
  scroll_position integer DEFAULT 0,
  time_spent_seconds integer DEFAULT 0,
  is_completed boolean DEFAULT false,
  completed_at timestamp with time zone,
  last_read_at timestamp with time zone DEFAULT now(),
  CONSTRAINT reading_progress_pkey PRIMARY KEY (id),
  CONSTRAINT reading_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.return_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  order_id text NOT NULL,
  order_item_id uuid,
  reason text NOT NULL CHECK (reason = ANY (ARRAY['defective'::text, 'wrong_item'::text, 'not_as_described'::text, 'changed_mind'::text, 'damaged_in_shipping'::text, 'duplicate_order'::text, 'quality_issue'::text, 'other'::text])),
  description text,
  evidence_urls ARRAY,
  return_type text NOT NULL CHECK (return_type = ANY (ARRAY['refund'::text, 'replacement'::text, 'store_credit'::text, 'repair'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'processing'::text, 'completed'::text, 'cancelled'::text])),
  refund_amount numeric DEFAULT 0,
  admin_notes text,
  reviewed_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  CONSTRAINT return_requests_pkey PRIMARY KEY (id),
  CONSTRAINT return_requests_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT return_requests_order_item_id_fkey FOREIGN KEY (order_item_id) REFERENCES public.order_items(id),
  CONSTRAINT return_requests_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.users(id)
);
CREATE TABLE public.revenue_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  date date NOT NULL UNIQUE,
  gross_revenue numeric DEFAULT 0,
  net_revenue numeric DEFAULT 0,
  refunds_total numeric DEFAULT 0,
  discounts_total numeric DEFAULT 0,
  tax_collected numeric DEFAULT 0,
  transaction_fees numeric DEFAULT 0,
  new_subscriptions integer DEFAULT 0,
  subscription_revenue numeric DEFAULT 0,
  one_time_revenue numeric DEFAULT 0,
  mrr numeric DEFAULT 0,
  arr numeric DEFAULT 0,
  arpu numeric DEFAULT 0,
  ltv_avg numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT revenue_analytics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.scheduled_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  report_name text NOT NULL,
  report_type text NOT NULL CHECK (report_type = ANY (ARRAY['user_growth'::text, 'revenue'::text, 'churn'::text, 'segment_analysis'::text, 'product_performance'::text, 'campaign_results'::text, 'daily_summary'::text, 'weekly_summary'::text])),
  frequency text NOT NULL CHECK (frequency = ANY (ARRAY['daily'::text, 'weekly'::text, 'monthly'::text, 'quarterly'::text])),
  recipient_emails ARRAY,
  recipient_user_ids ARRAY,
  filters jsonb DEFAULT '{}'::jsonb,
  last_run_at timestamp with time zone,
  next_run_at timestamp with time zone,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT scheduled_reports_pkey PRIMARY KEY (id),
  CONSTRAINT scheduled_reports_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.sdk_downloads (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  sdk_language text NOT NULL CHECK (sdk_language = ANY (ARRAY['javascript'::text, 'python'::text, 'php'::text, 'ruby'::text, 'java'::text, 'go'::text, 'csharp'::text, 'swift'::text, 'kotlin'::text, 'dart'::text])),
  sdk_version text NOT NULL,
  download_count integer DEFAULT 1,
  first_downloaded_at timestamp with time zone DEFAULT now(),
  last_downloaded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT sdk_downloads_pkey PRIMARY KEY (id),
  CONSTRAINT sdk_downloads_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.security_alerts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  alert_type text NOT NULL CHECK (alert_type = ANY (ARRAY['login_new_device'::text, 'login_new_location'::text, 'password_changed'::text, 'email_changed'::text, 'suspicious_login'::text, 'multiple_failed_logins'::text, 'data_export_requested'::text, 'account_compromised'::text, 'unusual_purchase'::text, '2fa_disabled'::text])),
  severity text DEFAULT 'medium'::text CHECK (severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  title text NOT NULL,
  message text,
  metadata jsonb DEFAULT '{}'::jsonb,
  is_read boolean DEFAULT false,
  is_resolved boolean DEFAULT false,
  ip_address inet,
  device_info text,
  created_at timestamp with time zone DEFAULT now(),
  read_at timestamp with time zone,
  CONSTRAINT security_alerts_pkey PRIMARY KEY (id),
  CONSTRAINT security_alerts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.seo_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  entity_type text NOT NULL CHECK (entity_type = ANY (ARRAY['product'::text, 'page'::text, 'blog'::text, 'category'::text, 'landing_page'::text])),
  entity_id text NOT NULL,
  title text,
  description text,
  keywords text,
  og_title text,
  og_description text,
  og_image_url text,
  twitter_card text DEFAULT 'summary_large_image'::text,
  canonical_url text,
  robots text DEFAULT 'index,follow'::text,
  schema_markup jsonb DEFAULT '{}'::jsonb,
  sitemap_priority numeric DEFAULT 0.5,
  sitemap_changefreq text DEFAULT 'weekly'::text,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT seo_settings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shared_workspaces (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  owner_id uuid NOT NULL,
  workspace_name text NOT NULL,
  workspace_type text CHECK (workspace_type = ANY (ARRAY['personal'::text, 'team'::text, 'family'::text, 'business'::text, 'project'::text])),
  description text,
  invite_code text UNIQUE,
  member_limit integer DEFAULT 5,
  storage_limit_gb integer DEFAULT 10,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT shared_workspaces_pkey PRIMARY KEY (id),
  CONSTRAINT shared_workspaces_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.users(id)
);
CREATE TABLE public.shipment_tracking_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  shipment_id uuid NOT NULL,
  status text NOT NULL,
  location text,
  description text,
  event_time timestamp with time zone DEFAULT now(),
  CONSTRAINT shipment_tracking_events_pkey PRIMARY KEY (id),
  CONSTRAINT shipment_tracking_events_shipment_id_fkey FOREIGN KEY (shipment_id) REFERENCES public.order_shipments(id)
);
CREATE TABLE public.shopping_list_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  list_id uuid NOT NULL,
  product_id text NOT NULL,
  quantity integer DEFAULT 1,
  priority text CHECK (priority = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'urgent'::text])),
  is_purchased boolean DEFAULT false,
  purchased_at timestamp with time zone,
  notes text,
  added_at timestamp with time zone DEFAULT now(),
  CONSTRAINT shopping_list_items_pkey PRIMARY KEY (id),
  CONSTRAINT shopping_list_items_list_id_fkey FOREIGN KEY (list_id) REFERENCES public.smart_shopping_lists(id)
);
CREATE TABLE public.smart_shopping_lists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  list_name text NOT NULL,
  list_type text CHECK (list_type = ANY (ARRAY['manual'::text, 'auto_replenish'::text, 'subscription'::text, 'gift_registry'::text, 'project_based'::text])),
  is_recurring boolean DEFAULT false,
  recurrence_pattern text,
  next_purchase_date date,
  budget_limit numeric,
  is_shared boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT smart_shopping_lists_pkey PRIMARY KEY (id),
  CONSTRAINT smart_shopping_lists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.sms_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recipient_phone text NOT NULL,
  recipient_user_id uuid,
  message text NOT NULL,
  gateway text DEFAULT 'twilio'::text CHECK (gateway = ANY (ARRAY['twilio'::text, 'nexmo'::text, 'ssl_wireless'::text, 'shohoz'::text, 'infobip'::text])),
  status text DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'sending'::text, 'sent'::text, 'delivered'::text, 'failed'::text, 'expired'::text])),
  gateway_message_id text,
  cost numeric DEFAULT 0,
  retry_count integer DEFAULT 0,
  scheduled_at timestamp with time zone DEFAULT now(),
  sent_at timestamp with time zone,
  delivered_at timestamp with time zone,
  failed_reason text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT sms_queue_pkey PRIMARY KEY (id),
  CONSTRAINT sms_queue_recipient_user_id_fkey FOREIGN KEY (recipient_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.sso_activity_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_id uuid NOT NULL,
  session_id uuid,
  activity_type text NOT NULL CHECK (activity_type = ANY (ARRAY['login'::text, 'logout'::text, 'token_refresh'::text, 'access_denied'::text, 'session_expired'::text, 'force_logout'::text, 'account_switch'::text])),
  ip_address inet,
  device_type text,
  success boolean DEFAULT true,
  failure_reason text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT sso_activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT sso_activity_logs_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.sso_user_sessions(id),
  CONSTRAINT sso_activity_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT sso_activity_logs_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.zipra_apps(id)
);
CREATE TABLE public.sso_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_id uuid NOT NULL,
  session_token text NOT NULL UNIQUE,
  ip_address inet,
  device_info text,
  location text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  last_activity timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  CONSTRAINT sso_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT sso_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT sso_sessions_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.zipra_apps(id)
);
CREATE TABLE public.sso_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_id uuid NOT NULL,
  access_token text NOT NULL UNIQUE,
  refresh_token text NOT NULL UNIQUE,
  ip_address inet,
  device_info text,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  last_used timestamp with time zone DEFAULT now(),
  CONSTRAINT sso_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT sso_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT sso_tokens_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.zipra_apps(id)
);
CREATE TABLE public.sso_user_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_id uuid NOT NULL,
  session_token text NOT NULL DEFAULT encode(gen_random_bytes(32), 'hex'::text) UNIQUE,
  refresh_token text DEFAULT encode(gen_random_bytes(32), 'hex'::text) UNIQUE,
  ip_address inet,
  device_type text,
  device_name text,
  os text,
  browser text,
  location text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  last_activity timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '30 days'::interval),
  logged_out_at timestamp with time zone,
  CONSTRAINT sso_user_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT sso_user_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT sso_user_sessions_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.zipra_apps(id)
);
CREATE TABLE public.story_views (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  story_id uuid NOT NULL,
  viewer_id uuid NOT NULL,
  viewed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT story_views_pkey PRIMARY KEY (id),
  CONSTRAINT story_views_story_id_fkey FOREIGN KEY (story_id) REFERENCES public.user_stories(id),
  CONSTRAINT story_views_viewer_id_fkey FOREIGN KEY (viewer_id) REFERENCES public.users(id)
);
CREATE TABLE public.subscription_plans (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  plan_name text NOT NULL UNIQUE,
  plan_code text NOT NULL UNIQUE,
  description text,
  features jsonb DEFAULT '[]'::jsonb,
  limits jsonb DEFAULT '{}'::jsonb,
  monthly_price numeric DEFAULT 0,
  yearly_price numeric DEFAULT 0,
  lifetime_price numeric,
  currency text DEFAULT 'BDT'::text,
  trial_days integer DEFAULT 0,
  is_popular boolean DEFAULT false,
  is_active boolean DEFAULT true,
  display_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscription_plans_pkey PRIMARY KEY (id)
);
CREATE TABLE public.support_agents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  agent_code text NOT NULL UNIQUE,
  department text CHECK (department = ANY (ARRAY['billing'::text, 'technical'::text, 'general'::text, 'vip'::text, 'fraud'::text])),
  is_online boolean DEFAULT false,
  max_concurrent_tickets integer DEFAULT 10,
  active_ticket_count integer DEFAULT 0,
  total_resolved integer DEFAULT 0,
  avg_resolution_time_hours numeric DEFAULT 0,
  satisfaction_score numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT support_agents_pkey PRIMARY KEY (id),
  CONSTRAINT support_agents_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.support_ticket_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ticket_id uuid NOT NULL,
  sender_id uuid,
  sender_type text NOT NULL CHECK (sender_type = ANY (ARRAY['user'::text, 'agent'::text, 'bot'::text, 'system'::text])),
  message text NOT NULL,
  attachment_urls ARRAY,
  is_internal boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT support_ticket_messages_pkey PRIMARY KEY (id),
  CONSTRAINT support_ticket_messages_ticket_id_fkey FOREIGN KEY (ticket_id) REFERENCES public.user_support_tickets(id),
  CONSTRAINT support_ticket_messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(id)
);
CREATE TABLE public.survey_responses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  survey_id uuid NOT NULL,
  user_id uuid,
  answers jsonb NOT NULL DEFAULT '{}'::jsonb,
  nps_score integer CHECK (nps_score IS NULL OR nps_score >= 0 AND nps_score <= 10),
  completed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT survey_responses_pkey PRIMARY KEY (id),
  CONSTRAINT survey_responses_survey_id_fkey FOREIGN KEY (survey_id) REFERENCES public.surveys(id),
  CONSTRAINT survey_responses_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.surveys (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  title text NOT NULL,
  description text,
  type text DEFAULT 'survey'::text CHECK (type = ANY (ARRAY['survey'::text, 'poll'::text, 'quiz'::text, 'nps'::text, 'csat'::text])),
  questions jsonb NOT NULL DEFAULT '[]'::jsonb,
  target_segments ARRAY,
  target_countries ARRAY,
  is_anonymous boolean DEFAULT true,
  is_active boolean DEFAULT true,
  starts_at timestamp with time zone DEFAULT now(),
  ends_at timestamp with time zone,
  response_count integer DEFAULT 0,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT surveys_pkey PRIMARY KEY (id),
  CONSTRAINT surveys_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.system_health_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  service text NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['healthy'::text, 'degraded'::text, 'down'::text, 'maintenance'::text])),
  response_time_ms integer,
  error_message text,
  error_count integer DEFAULT 0,
  cpu_usage numeric,
  memory_usage numeric,
  active_connections integer,
  checked_at timestamp with time zone DEFAULT now(),
  CONSTRAINT system_health_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.tax_config (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  country text NOT NULL,
  region text,
  tax_name text NOT NULL,
  tax_rate numeric NOT NULL,
  tax_type text CHECK (tax_type = ANY (ARRAY['vat'::text, 'gst'::text, 'sales_tax'::text, 'service_tax'::text, 'custom'::text])),
  is_inclusive boolean DEFAULT false,
  applicable_categories ARRAY,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tax_config_pkey PRIMARY KEY (id)
);
CREATE TABLE public.translations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  key text NOT NULL,
  language text NOT NULL,
  value text NOT NULL,
  context text,
  is_approved boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT translations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_2fa (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  method text NOT NULL DEFAULT 'totp'::text CHECK (method = ANY (ARRAY['totp'::text, 'sms'::text, 'email'::text, 'backup_code'::text])),
  secret_key text,
  backup_codes ARRAY,
  is_enabled boolean DEFAULT false,
  last_used_at timestamp with time zone,
  enabled_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  totp_app_name text,
  sms_phone text,
  backup_codes_generated_at timestamp with time zone,
  backup_codes_used_count integer DEFAULT 0,
  recovery_codes_remaining integer DEFAULT 8,
  grace_period_ends_at timestamp with time zone,
  hardware_key_type text,
  hardware_key_registered_at timestamp with time zone,
  CONSTRAINT user_2fa_pkey PRIMARY KEY (id),
  CONSTRAINT user_2fa_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_2fa_attempts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  method text,
  ip_address inet,
  is_success boolean DEFAULT false,
  attempted_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_2fa_attempts_pkey PRIMARY KEY (id),
  CONSTRAINT user_2fa_attempts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_ab_tests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  test_name text NOT NULL,
  variant text NOT NULL,
  converted boolean DEFAULT false,
  conversion_value numeric DEFAULT 0.00,
  assigned_at timestamp with time zone DEFAULT now(),
  converted_at timestamp with time zone,
  CONSTRAINT user_ab_tests_pkey PRIMARY KEY (id),
  CONSTRAINT user_ab_tests_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_account_deletion_schedule (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  requested_at timestamp with time zone NOT NULL DEFAULT now(),
  scheduled_deletion_at timestamp with time zone NOT NULL,
  reason text,
  confirmation_code text NOT NULL,
  is_confirmed boolean DEFAULT false,
  confirmed_at timestamp with time zone,
  grace_period_ends_at timestamp with time zone,
  final_deletion_at timestamp with time zone,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'grace_period'::text, 'processing'::text, 'completed'::text, 'cancelled'::text])),
  cancelled_at timestamp with time zone,
  cancelled_reason text,
  CONSTRAINT user_account_deletion_schedule_pkey PRIMARY KEY (id),
  CONSTRAINT user_account_deletion_schedule_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_account_recovery_options (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  recovery_type text NOT NULL CHECK (recovery_type = ANY (ARRAY['email'::text, 'phone'::text, 'trusted_contact'::text, 'security_key'::text, 'identity_doc'::text, 'backup_code'::text])),
  recovery_value text,
  recovery_value_masked text,
  is_verified boolean DEFAULT false,
  is_active boolean DEFAULT true,
  verified_at timestamp with time zone,
  last_used_at timestamp with time zone,
  added_from_ip inet,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_account_recovery_options_pkey PRIMARY KEY (id),
  CONSTRAINT user_account_recovery_options_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_activity_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  activity_category text NOT NULL CHECK (activity_category = ANY (ARRAY['search'::text, 'browse'::text, 'purchase'::text, 'media'::text, 'social'::text, 'app_use'::text, 'voice'::text, 'location'::text, 'payment'::text])),
  activity_type text NOT NULL,
  title text,
  description text,
  url text,
  product_id text,
  metadata jsonb DEFAULT '{}'::jsonb,
  ip_address inet,
  device_type text,
  auto_delete_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_activity_history_pkey PRIMARY KEY (id),
  CONSTRAINT user_activity_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_activity_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  action text NOT NULL,
  details jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  device_type text,
  device_name text,
  browser text,
  os text,
  ip_address inet,
  location text,
  is_successful boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  session_id text,
  country_code text,
  city_name text,
  CONSTRAINT user_activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT user_activity_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_ad_interactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  ad_id text NOT NULL,
  campaign_id text,
  ad_type text CHECK (ad_type = ANY (ARRAY['banner'::text, 'popup'::text, 'email'::text, 'push'::text, 'sms'::text, 'in_feed'::text, 'retarget'::text])),
  product_id text,
  segment_code text,
  action text NOT NULL CHECK (action = ANY (ARRAY['view'::text, 'click'::text, 'skip'::text, 'convert'::text, 'dismiss'::text])),
  revenue_generated numeric DEFAULT 0.00,
  device_type text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT user_ad_interactions_pkey PRIMARY KEY (id),
  CONSTRAINT user_ad_interactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_ad_personalization (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  ad_personalization_enabled boolean DEFAULT true,
  interest_topics jsonb DEFAULT '[]'::jsonb,
  excluded_advertisers jsonb DEFAULT '[]'::jsonb,
  sensitive_topics jsonb DEFAULT '[]'::jsonb,
  reminder_ads_enabled boolean DEFAULT true,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_ad_personalization_pkey PRIMARY KEY (id),
  CONSTRAINT user_ad_personalization_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_addresses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  label text DEFAULT 'Home'::text CHECK (label = ANY (ARRAY['Home'::text, 'Work'::text, 'Other'::text])),
  full_name text NOT NULL,
  phone text,
  address_line_1 text NOT NULL,
  address_line_2 text,
  city text NOT NULL,
  area text,
  postal_code text,
  country text DEFAULT 'Bangladesh'::text,
  is_default boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  latitude numeric,
  longitude numeric,
  delivery_instructions text,
  gate_code text,
  building_name text,
  floor_number text,
  apartment_number text,
  is_commercial boolean DEFAULT false,
  verified_at timestamp with time zone,
  CONSTRAINT user_addresses_pkey PRIMARY KEY (id),
  CONSTRAINT user_addresses_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_ai_interactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  interaction_type text CHECK (interaction_type = ANY (ARRAY['chat'::text, 'recommendation'::text, 'generation'::text, 'analysis'::text, 'translation'::text, 'summarization'::text])),
  input_text text,
  output_text text,
  model_used text,
  tokens_used integer,
  response_time_ms integer,
  satisfaction_rating integer CHECK (satisfaction_rating >= 1 AND satisfaction_rating <= 5),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_ai_interactions_pkey PRIMARY KEY (id),
  CONSTRAINT user_ai_interactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_ai_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  ai_assistant_enabled boolean DEFAULT true,
  ai_recommendations_enabled boolean DEFAULT true,
  ai_content_generation_enabled boolean DEFAULT true,
  preferred_ai_model text DEFAULT 'claude-sonnet'::text,
  ai_personality text DEFAULT 'balanced'::text CHECK (ai_personality = ANY (ARRAY['professional'::text, 'casual'::text, 'creative'::text, 'balanced'::text, 'technical'::text])),
  ai_language_preference text DEFAULT 'bn'::text,
  conversation_memory_enabled boolean DEFAULT true,
  personalization_level text DEFAULT 'high'::text CHECK (personalization_level = ANY (ARRAY['none'::text, 'low'::text, 'medium'::text, 'high'::text, 'maximum'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_ai_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT user_ai_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_app_access (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_id uuid NOT NULL,
  access_type text DEFAULT 'free'::text CHECK (access_type = ANY (ARRAY['free'::text, 'trial'::text, 'paid'::text, 'gifted'::text, 'admin'::text, 'beta'::text])),
  granted_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone,
  is_active boolean DEFAULT true,
  first_login_at timestamp with time zone,
  last_login_at timestamp with time zone,
  total_login_count integer DEFAULT 0,
  total_usage_minutes integer DEFAULT 0,
  CONSTRAINT user_app_access_pkey PRIMARY KEY (id),
  CONSTRAINT user_app_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_app_access_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.zipra_apps(id)
);
CREATE TABLE public.user_app_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_id uuid NOT NULL,
  notifications_enabled boolean DEFAULT true,
  location_access text DEFAULT 'never'::text CHECK (location_access = ANY (ARRAY['always'::text, 'while_using'::text, 'never'::text])),
  camera_access boolean DEFAULT false,
  microphone_access boolean DEFAULT false,
  contacts_access boolean DEFAULT false,
  storage_access boolean DEFAULT false,
  biometric_access boolean DEFAULT false,
  background_refresh boolean DEFAULT true,
  data_saver boolean DEFAULT false,
  auto_update boolean DEFAULT true,
  show_in_search boolean DEFAULT true,
  custom_settings jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_app_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_app_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_app_usage_timeline (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_name text NOT NULL,
  activity_type text NOT NULL CHECK (activity_type = ANY (ARRAY['visit'::text, 'search'::text, 'view'::text, 'click'::text, 'save'::text, 'share'::text, 'create'::text, 'edit'::text, 'delete'::text, 'purchase'::text])),
  item_title text,
  item_url text,
  item_description text,
  occurred_at timestamp with time zone NOT NULL DEFAULT now(),
  deleted_at timestamp with time zone,
  is_deleted boolean DEFAULT false,
  CONSTRAINT user_app_usage_timeline_pkey PRIMARY KEY (id),
  CONSTRAINT user_app_usage_timeline_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_automations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  automation_name text NOT NULL,
  trigger_type text NOT NULL,
  trigger_config jsonb NOT NULL,
  action_type text NOT NULL,
  action_config jsonb NOT NULL,
  is_enabled boolean DEFAULT true,
  run_count integer DEFAULT 0,
  last_run_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_automations_pkey PRIMARY KEY (id),
  CONSTRAINT user_automations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_badges (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  badge_id uuid NOT NULL,
  earned_at timestamp with time zone DEFAULT now(),
  is_displayed boolean DEFAULT true,
  CONSTRAINT user_badges_pkey PRIMARY KEY (id),
  CONSTRAINT user_badges_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_badges_badge_id_fkey FOREIGN KEY (badge_id) REFERENCES public.badges(id)
);
CREATE TABLE public.user_behavioral_biometrics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  avg_typing_speed numeric,
  avg_keystroke_dwell numeric,
  avg_keystroke_flight numeric,
  mouse_movement_pattern text,
  scroll_behavior text,
  touch_pressure_avg numeric,
  swipe_speed_avg numeric,
  session_consistency_score numeric DEFAULT 0,
  is_anomaly boolean DEFAULT false,
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_behavioral_biometrics_pkey PRIMARY KEY (id),
  CONSTRAINT user_behavioral_biometrics_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_blocks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  blocker_id uuid NOT NULL,
  blocked_id uuid NOT NULL,
  reason text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_blocks_pkey PRIMARY KEY (id),
  CONSTRAINT user_blocks_blocker_id_fkey FOREIGN KEY (blocker_id) REFERENCES public.users(id),
  CONSTRAINT user_blocks_blocked_id_fkey FOREIGN KEY (blocked_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_carbon_footprint (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  month date NOT NULL,
  shipping_emissions_kg numeric DEFAULT 0,
  product_emissions_kg numeric DEFAULT 0,
  total_emissions_kg numeric DEFAULT 0,
  offset_purchased_kg numeric DEFAULT 0,
  trees_equivalent numeric DEFAULT 0,
  CONSTRAINT user_carbon_footprint_pkey PRIMARY KEY (id),
  CONSTRAINT user_carbon_footprint_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_carts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  product_name text,
  quantity integer DEFAULT 1,
  price numeric,
  added_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_carts_pkey PRIMARY KEY (id),
  CONSTRAINT user_carts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_challenge_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  challenge_id uuid NOT NULL,
  progress integer DEFAULT 0,
  is_completed boolean DEFAULT false,
  completed_at timestamp with time zone,
  reward_claimed boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_challenge_progress_pkey PRIMARY KEY (id),
  CONSTRAINT user_challenge_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_challenge_progress_challenge_id_fkey FOREIGN KEY (challenge_id) REFERENCES public.daily_challenges(id)
);
CREATE TABLE public.user_circles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  circle_name text NOT NULL,
  description text,
  is_default boolean DEFAULT false,
  member_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_circles_pkey PRIMARY KEY (id),
  CONSTRAINT user_circles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_collections (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  collection_name text NOT NULL,
  description text,
  cover_image_url text,
  collection_type text CHECK (collection_type = ANY (ARRAY['products'::text, 'media'::text, 'posts'::text, 'mixed'::text, 'inspiration'::text])),
  is_public boolean DEFAULT false,
  is_collaborative boolean DEFAULT false,
  item_count integer DEFAULT 0,
  follower_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_collections_pkey PRIMARY KEY (id),
  CONSTRAINT user_collections_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_compare_lists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  product_ids ARRAY NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_compare_lists_pkey PRIMARY KEY (id),
  CONSTRAINT user_compare_lists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_connected_apps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_name text NOT NULL,
  app_slug text NOT NULL,
  app_icon_url text,
  app_icon_svg text,
  app_description text,
  app_category text CHECK (app_category = ANY (ARRAY['social'::text, 'productivity'::text, 'developer'::text, 'finance'::text, 'media'::text, 'storage'::text, 'communication'::text, 'analytics'::text, 'ecommerce'::text, 'zipra_product'::text, 'other'::text])),
  connection_type text DEFAULT 'oauth'::text CHECK (connection_type = ANY (ARRAY['oauth'::text, 'sso'::text, 'api_key'::text, 'webhook'::text, 'manual'::text])),
  provider text CHECK (provider = ANY (ARRAY['google'::text, 'facebook'::text, 'apple'::text, 'github'::text, 'twitter'::text, 'linkedin'::text, 'slack'::text, 'notion'::text, 'trello'::text, 'figma'::text, 'shopify'::text, 'stripe'::text, 'zapier'::text, 'discord'::text, 'telegram'::text, 'whatsapp'::text, 'tiktok'::text, 'dropbox'::text, 'onedrive'::text, 'zoom'::text, 'spotify'::text, 'zipra_internal'::text, 'custom'::text])),
  zipra_app_id uuid,
  provider_user_id text,
  provider_email text,
  provider_username text,
  provider_avatar text,
  access_token_ref text,
  refresh_token_ref text,
  token_expires_at timestamp with time zone,
  scopes ARRAY DEFAULT ARRAY[]::text[],
  permissions jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  is_primary boolean DEFAULT false,
  last_synced_at timestamp with time zone,
  sync_error text,
  connected_at timestamp with time zone DEFAULT now(),
  disconnected_at timestamp with time zone,
  extra_data jsonb DEFAULT '{}'::jsonb,
  app_id uuid,
  data_access_last_reviewed_at timestamp with time zone,
  auto_revoke_after_days integer,
  can_post_on_behalf boolean DEFAULT false,
  can_read_messages boolean DEFAULT false,
  can_access_contacts boolean DEFAULT false,
  can_access_location boolean DEFAULT false,
  risk_level text DEFAULT 'low'::text,
  CONSTRAINT user_connected_apps_pkey PRIMARY KEY (id),
  CONSTRAINT user_connected_apps_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_connected_apps_zipra_app_id_fkey FOREIGN KEY (zipra_app_id) REFERENCES public.zipra_apps(id),
  CONSTRAINT user_connected_apps_app_id_fkey FOREIGN KEY (app_id) REFERENCES public.zipra_apps(id)
);
CREATE TABLE public.user_connections (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  requester_id uuid NOT NULL,
  addressee_id uuid NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'accepted'::text, 'declined'::text, 'blocked'::text])),
  requested_at timestamp with time zone DEFAULT now(),
  responded_at timestamp with time zone,
  CONSTRAINT user_connections_pkey PRIMARY KEY (id),
  CONSTRAINT user_connections_requester_id_fkey FOREIGN KEY (requester_id) REFERENCES public.users(id),
  CONSTRAINT user_connections_addressee_id_fkey FOREIGN KEY (addressee_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_consents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  consent_type text NOT NULL CHECK (consent_type = ANY (ARRAY['terms_of_service'::text, 'privacy_policy'::text, 'marketing'::text, 'analytics'::text, 'cookies'::text, 'third_party_sharing'::text, 'data_processing'::text, 'age_verification'::text])),
  version text NOT NULL,
  is_granted boolean DEFAULT false,
  granted_at timestamp with time zone,
  withdrawn_at timestamp with time zone,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_consents_pkey PRIMARY KEY (id),
  CONSTRAINT user_consents_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_content_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  preferred_genres ARRAY,
  disliked_genres ARRAY,
  preferred_languages ARRAY,
  content_maturity_level text DEFAULT 'all'::text,
  autoplay_enabled boolean DEFAULT true,
  autoplay_next_episode boolean DEFAULT true,
  skip_intro_enabled boolean DEFAULT false,
  default_playback_quality text DEFAULT 'auto'::text,
  default_playback_speed numeric DEFAULT 1.0,
  download_quality text DEFAULT 'standard'::text,
  subtitles_default_language text,
  subtitles_font_size text DEFAULT 'medium'::text,
  subtitles_background boolean DEFAULT false,
  audio_description_default boolean DEFAULT false,
  data_saver_mode boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_content_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT user_content_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_creator_monetization (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  is_eligible boolean DEFAULT false,
  eligibility_checked_at timestamp with time zone,
  monetization_enabled boolean DEFAULT false,
  enabled_at timestamp with time zone,
  revenue_model ARRAY DEFAULT ARRAY['ads'::text],
  ad_revenue_total numeric DEFAULT 0,
  subscription_revenue_total numeric DEFAULT 0,
  tip_revenue_total numeric DEFAULT 0,
  merchandise_revenue_total numeric DEFAULT 0,
  affiliate_revenue_total numeric DEFAULT 0,
  total_revenue numeric DEFAULT 0,
  pending_payout numeric DEFAULT 0,
  lifetime_payout numeric DEFAULT 0,
  payout_threshold numeric DEFAULT 1000,
  payout_currency text DEFAULT 'BDT'::text,
  tax_form_submitted boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_creator_monetization_pkey PRIMARY KEY (id),
  CONSTRAINT user_creator_monetization_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_credit_scores (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  credit_score integer DEFAULT 500 CHECK (credit_score >= 300 AND credit_score <= 850),
  payment_history_score integer,
  purchase_consistency_score integer,
  account_age_score integer,
  return_rate_impact integer,
  last_calculated_at timestamp with time zone DEFAULT now(),
  calculation_details jsonb,
  CONSTRAINT user_credit_scores_pkey PRIMARY KEY (id),
  CONSTRAINT user_credit_scores_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_custom_themes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  primary_color text DEFAULT '#6366f1'::text,
  secondary_color text DEFAULT '#8b5cf6'::text,
  accent_color text DEFAULT '#06b6d4'::text,
  background_color text DEFAULT '#ffffff'::text,
  text_color text DEFAULT '#111827'::text,
  font_family text DEFAULT 'Inter'::text,
  border_radius text DEFAULT 'medium'::text,
  custom_css text,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_custom_themes_pkey PRIMARY KEY (id),
  CONSTRAINT user_custom_themes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_daily_activity (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  activity_date date NOT NULL,
  sessions_count integer DEFAULT 0,
  total_time_minutes integer DEFAULT 0,
  pages_viewed integer DEFAULT 0,
  products_viewed integer DEFAULT 0,
  searches_count integer DEFAULT 0,
  ads_seen integer DEFAULT 0,
  ads_clicked integer DEFAULT 0,
  purchases_count integer DEFAULT 0,
  amount_spent numeric DEFAULT 0.00,
  events_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_daily_activity_pkey PRIMARY KEY (id),
  CONSTRAINT user_daily_activity_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_data_export_archives (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  export_request_id uuid NOT NULL,
  archive_url text NOT NULL,
  archive_size_bytes bigint NOT NULL,
  file_count integer NOT NULL,
  expires_at timestamp with time zone NOT NULL,
  downloaded_at timestamp with time zone,
  download_count integer DEFAULT 0,
  checksum text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_data_export_archives_pkey PRIMARY KEY (id),
  CONSTRAINT user_data_export_archives_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_data_portability (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  request_type text NOT NULL CHECK (request_type = ANY (ARRAY['full_export'::text, 'profile_only'::text, 'purchases_only'::text, 'activity_only'::text, 'messages_only'::text, 'media_only'::text])),
  format text DEFAULT 'json'::text CHECK (format = ANY (ARRAY['json'::text, 'csv'::text, 'xml'::text, 'pdf'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'ready'::text, 'downloaded'::text, 'expired'::text, 'failed'::text])),
  file_size_mb numeric,
  download_url text,
  download_expires_at timestamp with time zone,
  download_count integer DEFAULT 0,
  includes_sections ARRAY,
  processing_started_at timestamp with time zone,
  ready_at timestamp with time zone,
  requested_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_data_portability_pkey PRIMARY KEY (id),
  CONSTRAINT user_data_portability_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_data_promises (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  promise_type text NOT NULL CHECK (promise_type = ANY (ARRAY['no_sell_data'::text, 'no_targeted_ads'::text, 'data_minimization'::text, 'transparency'::text, 'user_control'::text])),
  promised_at timestamp with time zone DEFAULT now(),
  last_verified_at timestamp with time zone,
  is_active boolean DEFAULT true,
  CONSTRAINT user_data_promises_pkey PRIMARY KEY (id),
  CONSTRAINT user_data_promises_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_data_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  request_type text NOT NULL CHECK (request_type = ANY (ARRAY['data_export'::text, 'data_delete'::text, 'data_correct'::text, 'restrict_processing'::text, 'withdraw_consent'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'rejected'::text])),
  reason text,
  admin_notes text,
  requested_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT user_data_requests_pkey PRIMARY KEY (id),
  CONSTRAINT user_data_requests_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_devices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  device_name text,
  device_type text CHECK (device_type = ANY (ARRAY['mobile'::text, 'tablet'::text, 'desktop'::text, 'smartwatch'::text, 'tv'::text, 'other'::text])),
  os text,
  os_version text,
  browser text,
  browser_version text,
  app_version text,
  screen_size text,
  device_fingerprint text UNIQUE,
  ip_address inet,
  location text,
  is_trusted boolean DEFAULT false,
  is_current boolean DEFAULT false,
  last_used_at timestamp with time zone DEFAULT now(),
  first_seen_at timestamp with time zone DEFAULT now(),
  last_active timestamp with time zone,
  is_2fa_device boolean DEFAULT false,
  push_token text,
  notification_enabled boolean DEFAULT true,
  auto_login_enabled boolean DEFAULT false,
  biometric_registered boolean DEFAULT false,
  removed_at timestamp with time zone,
  remove_reason text,
  device_nickname text,
  country_code text,
  city_name text,
  CONSTRAINT user_devices_pkey PRIMARY KEY (id),
  CONSTRAINT user_devices_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_digital_wellbeing (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  daily_limit_enabled boolean DEFAULT false,
  daily_limit_minutes integer DEFAULT 180,
  bedtime_mode_enabled boolean DEFAULT false,
  bedtime_start time without time zone DEFAULT '22:00:00'::time without time zone,
  bedtime_end time without time zone DEFAULT '07:00:00'::time without time zone,
  focus_mode_enabled boolean DEFAULT false,
  focus_mode_schedule jsonb DEFAULT '{}'::jsonb,
  app_timers jsonb DEFAULT '{}'::jsonb,
  grayscale_at_bedtime boolean DEFAULT false,
  notification_snooze_enabled boolean DEFAULT false,
  break_reminder_minutes integer DEFAULT 60,
  weekly_report_enabled boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_digital_wellbeing_pkey PRIMARY KEY (id),
  CONSTRAINT user_digital_wellbeing_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_engagement_scores (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  overall_score integer DEFAULT 0 CHECK (overall_score >= 0 AND overall_score <= 100),
  activity_score integer DEFAULT 0,
  social_score integer DEFAULT 0,
  purchase_score integer DEFAULT 0,
  content_score integer DEFAULT 0,
  loyalty_score integer DEFAULT 0,
  last_calculated_at timestamp with time zone DEFAULT now(),
  calculation_factors jsonb,
  CONSTRAINT user_engagement_scores_pkey PRIMARY KEY (id),
  CONSTRAINT user_engagement_scores_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  session_id uuid,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['page_view'::text, 'product_view'::text, 'category_view'::text, 'search'::text, 'add_to_cart'::text, 'remove_from_cart'::text, 'add_to_wishlist'::text, 'remove_from_wishlist'::text, 'checkout_start'::text, 'checkout_complete'::text, 'payment_start'::text, 'payment_complete'::text, 'ad_view'::text, 'ad_click'::text, 'ad_skip'::text, 'button_click'::text, 'link_click'::text, 'form_submit'::text, 'scroll_50'::text, 'scroll_75'::text, 'scroll_100'::text, 'video_play'::text, 'video_pause'::text, 'video_complete'::text, 'share'::text, 'review_submit'::text, 'rating_submit'::text, 'notification_open'::text, 'notification_dismiss'::text, 'login'::text, 'logout'::text, 'signup'::text, 'feature_use'::text, 'feature_ignore'::text, 'error_encountered'::text, 'custom'::text])),
  event_data jsonb DEFAULT '{}'::jsonb,
  page_url text,
  referrer_url text,
  device_type text,
  ip_address inet,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT user_events_pkey PRIMARY KEY (id),
  CONSTRAINT user_events_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_export_jobs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  job_id text NOT NULL UNIQUE,
  data_categories jsonb NOT NULL,
  file_format text DEFAULT 'zip'::text CHECK (file_format = ANY (ARRAY['zip'::text, 'tgz'::text, 'tbz'::text])),
  archive_size_bytes bigint,
  file_count integer,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'collecting'::text, 'processing'::text, 'complete'::text, 'failed'::text])),
  progress_percent integer DEFAULT 0,
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  expires_at timestamp with time zone,
  download_url text,
  download_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_export_jobs_pkey PRIMARY KEY (id),
  CONSTRAINT user_export_jobs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_family_sharing (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organizer_id uuid NOT NULL,
  member_id uuid NOT NULL,
  role text DEFAULT 'member'::text CHECK (role = ANY (ARRAY['organizer'::text, 'adult'::text, 'child'::text, 'teen'::text])),
  can_share_purchases boolean DEFAULT true,
  can_share_subscriptions boolean DEFAULT true,
  purchase_approval_required boolean DEFAULT false,
  spending_limit_monthly numeric,
  screen_time_enabled boolean DEFAULT false,
  content_restrictions jsonb DEFAULT '{}'::jsonb,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'removed'::text])),
  invited_at timestamp with time zone DEFAULT now(),
  joined_at timestamp with time zone,
  CONSTRAINT user_family_sharing_pkey PRIMARY KEY (id),
  CONSTRAINT user_family_sharing_organizer_id_fkey FOREIGN KEY (organizer_id) REFERENCES public.users(id),
  CONSTRAINT user_family_sharing_member_id_fkey FOREIGN KEY (member_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_feed_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  show_trending boolean DEFAULT true,
  show_recommended boolean DEFAULT true,
  show_new_arrivals boolean DEFAULT true,
  show_deals boolean DEFAULT true,
  show_followed_creators boolean DEFAULT true,
  hide_seen_products boolean DEFAULT false,
  refresh_frequency text DEFAULT 'realtime'::text CHECK (refresh_frequency = ANY (ARRAY['realtime'::text, 'hourly'::text, 'daily'::text])),
  preferred_price_min numeric DEFAULT 0,
  preferred_price_max numeric DEFAULT 99999,
  blocked_categories ARRAY,
  blocked_products ARRAY,
  feed_weights jsonb DEFAULT '{"trending": 20, "price_match": 15, "new_arrivals": 15, "social_proof": 10, "interest_score": 40}'::jsonb,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_feed_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_feed_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_feedback (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['bug'::text, 'feature_request'::text, 'general'::text, 'complaint'::text, 'praise'::text])),
  subject text,
  message text NOT NULL,
  rating integer CHECK (rating IS NULL OR rating >= 1 AND rating <= 5),
  page_url text,
  status text DEFAULT 'open'::text CHECK (status = ANY (ARRAY['open'::text, 'in_review'::text, 'resolved'::text, 'closed'::text])),
  admin_reply text,
  replied_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_feedback_pkey PRIMARY KEY (id),
  CONSTRAINT user_feedback_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_follows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  follower_id uuid NOT NULL,
  following_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_follows_pkey PRIMARY KEY (id),
  CONSTRAINT user_follows_follower_id_fkey FOREIGN KEY (follower_id) REFERENCES public.users(id),
  CONSTRAINT user_follows_following_id_fkey FOREIGN KEY (following_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_game_achievements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  achievement_id uuid NOT NULL,
  unlocked_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_game_achievements_pkey PRIMARY KEY (id),
  CONSTRAINT user_game_achievements_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_game_achievements_achievement_id_fkey FOREIGN KEY (achievement_id) REFERENCES public.game_achievements(id)
);
CREATE TABLE public.user_game_library (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  game_id uuid NOT NULL,
  play_time_minutes integer DEFAULT 0,
  last_played_at timestamp with time zone,
  is_favorite boolean DEFAULT false,
  purchase_price numeric DEFAULT 0.00,
  purchased_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_game_library_pkey PRIMARY KEY (id),
  CONSTRAINT user_game_library_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_game_library_game_id_fkey FOREIGN KEY (game_id) REFERENCES public.games(id)
);
CREATE TABLE public.user_goals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  goal_type text CHECK (goal_type = ANY (ARRAY['save_money'::text, 'learn_skill'::text, 'build_project'::text, 'grow_business'::text, 'increase_productivity'::text, 'launch_product'::text, 'other'::text])),
  title text NOT NULL,
  description text,
  target_date date,
  progress_percent integer DEFAULT 0 CHECK (progress_percent >= 0 AND progress_percent <= 100),
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'completed'::text, 'abandoned'::text])),
  related_products ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT user_goals_pkey PRIMARY KEY (id),
  CONSTRAINT user_goals_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_groups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  group_type text DEFAULT 'public'::text CHECK (group_type = ANY (ARRAY['public'::text, 'private'::text, 'secret'::text, 'invite_only'::text])),
  category text,
  cover_image_url text,
  icon_url text,
  owner_id uuid NOT NULL,
  member_count integer DEFAULT 1,
  post_count integer DEFAULT 0,
  rules text,
  is_verified boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_groups_pkey PRIMARY KEY (id),
  CONSTRAINT user_groups_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_heatmaps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  page_url text NOT NULL,
  click_x integer,
  click_y integer,
  scroll_depth integer,
  element_id text,
  element_type text,
  viewport_width integer,
  viewport_height integer,
  device_type text,
  session_count integer DEFAULT 1,
  date date DEFAULT CURRENT_DATE,
  CONSTRAINT user_heatmaps_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_identity_verification (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  verification_level text DEFAULT 'none'::text CHECK (verification_level = ANY (ARRAY['none'::text, 'basic'::text, 'standard'::text, 'enhanced'::text, 'full'::text])),
  document_type text CHECK (document_type = ANY (ARRAY['passport'::text, 'national_id'::text, 'driving_license'::text, 'birth_certificate'::text, 'utility_bill'::text, 'bank_statement'::text])),
  document_number_masked text,
  document_expiry date,
  document_country text,
  front_image_url text,
  back_image_url text,
  selfie_url text,
  liveness_check_passed boolean DEFAULT false,
  address_verified boolean DEFAULT false,
  phone_verified boolean DEFAULT false,
  email_verified boolean DEFAULT false,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'submitted'::text, 'reviewing'::text, 'approved'::text, 'rejected'::text, 'expired'::text])),
  rejection_reason text,
  verified_by text,
  verified_at timestamp with time zone,
  expires_at timestamp with time zone,
  submitted_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_identity_verification_pkey PRIMARY KEY (id),
  CONSTRAINT user_identity_verification_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_inactive_account_manager (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  is_enabled boolean DEFAULT false,
  timeout_months integer DEFAULT 3 CHECK (timeout_months = ANY (ARRAY[3, 6, 12, 18])),
  notify_contacts_before boolean DEFAULT true,
  auto_reply_enabled boolean DEFAULT false,
  auto_reply_message text,
  data_deletion_enabled boolean DEFAULT true,
  trusted_contacts jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_inactive_account_manager_pkey PRIMARY KEY (id),
  CONSTRAINT user_inactive_account_manager_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_interest_scores (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  category text NOT NULL,
  score integer DEFAULT 0 CHECK (score >= 0 AND score <= 100),
  view_count integer DEFAULT 0,
  purchase_count integer DEFAULT 0,
  search_count integer DEFAULT 0,
  wishlist_count integer DEFAULT 0,
  last_interacted_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_interest_scores_pkey PRIMARY KEY (id),
  CONSTRAINT user_interest_scores_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_invoices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  invoice_number text NOT NULL DEFAULT ((('INV-'::text || to_char(now(), 'YYYY'::text)) || '-'::text) || substr(md5((random())::text), 1, 8)) UNIQUE,
  order_ids ARRAY,
  subtotal numeric DEFAULT 0.00,
  discount_total numeric DEFAULT 0.00,
  tax_amount numeric DEFAULT 0.00,
  total_amount numeric NOT NULL,
  currency text DEFAULT 'BDT'::text,
  status text DEFAULT 'unpaid'::text CHECK (status = ANY (ARRAY['draft'::text, 'unpaid'::text, 'paid'::text, 'overdue'::text, 'cancelled'::text, 'refunded'::text])),
  payment_method text,
  payment_reference text,
  due_date date,
  paid_at timestamp with time zone,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_invoices_pkey PRIMARY KEY (id),
  CONSTRAINT user_invoices_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_journeys (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  session_id uuid,
  journey_type text CHECK (journey_type = ANY (ARRAY['purchase'::text, 'browsing'::text, 'research'::text, 'social'::text, 'support'::text, 'onboarding'::text])),
  start_page text,
  end_page text,
  pages_visited ARRAY,
  actions_taken jsonb,
  conversion_achieved boolean DEFAULT false,
  drop_off_point text,
  duration_seconds integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_journeys_pkey PRIMARY KEY (id),
  CONSTRAINT user_journeys_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_levels (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  current_level integer DEFAULT 1,
  current_xp integer DEFAULT 0,
  xp_to_next_level integer DEFAULT 100,
  total_xp_earned integer DEFAULT 0,
  level_title text DEFAULT 'Beginner'::text,
  perks_unlocked jsonb DEFAULT '[]'::jsonb,
  level_updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_levels_pkey PRIMARY KEY (id),
  CONSTRAINT user_levels_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_location_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  latitude numeric NOT NULL,
  longitude numeric NOT NULL,
  accuracy_meters integer,
  altitude_meters numeric,
  speed_kmh numeric,
  heading_degrees numeric,
  country text,
  city text,
  area text,
  place_name text,
  place_type text,
  source text DEFAULT 'gps'::text,
  is_home boolean DEFAULT false,
  is_work boolean DEFAULT false,
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_location_history_pkey PRIMARY KEY (id),
  CONSTRAINT user_location_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_locations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  latitude numeric,
  longitude numeric,
  accuracy_meters integer,
  country text,
  city text,
  area text,
  source text DEFAULT 'gps'::text CHECK (source = ANY (ARRAY['gps'::text, 'ip'::text, 'manual'::text, 'wifi'::text])),
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_locations_pkey PRIMARY KEY (id),
  CONSTRAINT user_locations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_login_methods (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  method text NOT NULL CHECK (method = ANY (ARRAY['password'::text, 'passkey'::text, 'sso'::text, 'oauth'::text, 'magic_link'::text, 'otp'::text, 'biometric'::text])),
  provider text,
  is_primary boolean DEFAULT false,
  is_enabled boolean DEFAULT true,
  last_used_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_login_methods_pkey PRIMARY KEY (id),
  CONSTRAINT user_login_methods_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_login_notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  session_id uuid,
  device_name text,
  device_type text,
  os text,
  browser text,
  ip_address inet,
  location text,
  country text,
  city text,
  login_method text DEFAULT 'password'::text,
  is_new_device boolean DEFAULT false,
  is_new_location boolean DEFAULT false,
  is_suspicious boolean DEFAULT false,
  email_sent boolean DEFAULT false,
  email_sent_at timestamp with time zone,
  sms_sent boolean DEFAULT false,
  sms_sent_at timestamp with time zone,
  push_sent boolean DEFAULT false,
  push_sent_at timestamp with time zone,
  was_blocked boolean DEFAULT false,
  user_confirmed boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_login_notifications_pkey PRIMARY KEY (id),
  CONSTRAINT user_login_notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_loyalty_points (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  points_earned integer DEFAULT 0,
  points_spent integer DEFAULT 0,
  points_balance integer DEFAULT 0,
  tier text DEFAULT 'bronze'::text CHECK (tier = ANY (ARRAY['bronze'::text, 'silver'::text, 'gold'::text, 'platinum'::text, 'diamond'::text])),
  tier_updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_loyalty_points_pkey PRIMARY KEY (id),
  CONSTRAINT user_loyalty_points_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_loyalty_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['earn'::text, 'spend'::text, 'expire'::text, 'bonus'::text, 'adjust'::text])),
  points integer NOT NULL,
  reason text,
  reference_id text,
  balance_after integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_loyalty_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT user_loyalty_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_mentions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  content_type text NOT NULL CHECK (content_type = ANY (ARRAY['post'::text, 'comment'::text, 'message'::text, 'review'::text, 'story'::text])),
  content_id uuid NOT NULL,
  mentioned_user_id uuid NOT NULL,
  mentioned_by_user_id uuid NOT NULL,
  is_read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_mentions_pkey PRIMARY KEY (id),
  CONSTRAINT user_mentions_mentioned_user_id_fkey FOREIGN KEY (mentioned_user_id) REFERENCES public.users(id),
  CONSTRAINT user_mentions_mentioned_by_user_id_fkey FOREIGN KEY (mentioned_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_milestones (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  milestone_type text NOT NULL CHECK (milestone_type = ANY (ARRAY['first_login'::text, 'first_purchase'::text, '100_days'::text, '1_year'::text, 'spend_1000'::text, 'spend_10000'::text, 'referral_10'::text, 'review_10'::text, 'top_buyer_month'::text, 'top_buyer_year'::text, 'custom'::text])),
  title text NOT NULL,
  description text,
  points_awarded integer DEFAULT 0,
  achieved_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_milestones_pkey PRIMARY KEY (id),
  CONSTRAINT user_milestones_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_mutes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  muted_type text NOT NULL CHECK (muted_type = ANY (ARRAY['user'::text, 'keyword'::text, 'hashtag'::text, 'category'::text])),
  muted_value text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_mutes_pkey PRIMARY KEY (id),
  CONSTRAINT user_mutes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_notes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  org_id uuid,
  title text,
  content text,
  content_json jsonb DEFAULT '{}'::jsonb,
  type text DEFAULT 'note'::text CHECK (type = ANY (ARRAY['note'::text, 'document'::text, 'spreadsheet'::text, 'presentation'::text, 'kanban'::text, 'whiteboard'::text])),
  color text,
  is_pinned boolean DEFAULT false,
  is_shared boolean DEFAULT false,
  is_trashed boolean DEFAULT false,
  tags ARRAY,
  word_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  reminder_at timestamp with time zone,
  reminder_sent boolean DEFAULT false,
  lock_enabled boolean DEFAULT false,
  lock_pin_hash text,
  version_count integer DEFAULT 1,
  last_edited_by uuid,
  CONSTRAINT user_notes_pkey PRIMARY KEY (id),
  CONSTRAINT user_notes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_notes_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.user_notification_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  notification_type text NOT NULL CHECK (notification_type = ANY (ARRAY['security_alerts'::text, 'account_activity'::text, 'product_updates'::text, 'newsletter'::text, 'social_activity'::text, 'promotions'::text, 'marketing'::text, 'verification_codes'::text, 'appointments'::text, 'messages'::text, 'mentions'::text, 'likes'::text, 'comments'::text, 'followers'::text, 'order_updates'::text, 'tips_tutorials'::text, 'achievements'::text, 'recommendations'::text])),
  email_enabled boolean DEFAULT true,
  sms_enabled boolean DEFAULT false,
  push_enabled boolean DEFAULT true,
  in_app_enabled boolean DEFAULT true,
  whatsapp_enabled boolean DEFAULT false,
  frequency text DEFAULT 'immediate'::text CHECK (frequency = ANY (ARRAY['immediate'::text, 'daily'::text, 'weekly'::text, 'never'::text])),
  quiet_hours_enabled boolean DEFAULT false,
  quiet_hours_start time without time zone,
  quiet_hours_end time without time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  telegram_enabled boolean DEFAULT false,
  desktop_enabled boolean DEFAULT true,
  sound_enabled boolean DEFAULT true,
  vibration_enabled boolean DEFAULT true,
  badge_count_enabled boolean DEFAULT true,
  preview_in_notification boolean DEFAULT true,
  group_notifications boolean DEFAULT false,
  notification_sound text DEFAULT 'default'::text,
  priority_level text DEFAULT 'normal'::text,
  CONSTRAINT user_notification_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_notification_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['push'::text, 'email'::text, 'sms'::text, 'whatsapp'::text, 'in_app'::text])),
  category text CHECK (category = ANY (ARRAY['promotion'::text, 'reminder'::text, 'alert'::text, 'welcome'::text, 'win_back'::text, 'cart_recovery'::text, 'price_drop'::text, 'new_product'::text, 'system'::text, 'custom'::text])),
  title text,
  body text,
  data jsonb DEFAULT '{}'::jsonb,
  segment_code text,
  campaign_id text,
  is_sent boolean DEFAULT false,
  is_delivered boolean DEFAULT false,
  is_opened boolean DEFAULT false,
  is_clicked boolean DEFAULT false,
  sent_at timestamp with time zone,
  delivered_at timestamp with time zone,
  opened_at timestamp with time zone,
  clicked_at timestamp with time zone,
  scheduled_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_notifications_pkey PRIMARY KEY (id),
  CONSTRAINT user_notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_onboarding (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  step_profile_done boolean DEFAULT false,
  step_interests_done boolean DEFAULT false,
  step_first_product_viewed boolean DEFAULT false,
  step_first_purchase_done boolean DEFAULT false,
  step_notification_setup boolean DEFAULT false,
  step_referral_shared boolean DEFAULT false,
  onboarding_completed boolean DEFAULT false,
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_onboarding_pkey PRIMARY KEY (id),
  CONSTRAINT user_onboarding_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_passkeys (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  credential_id text NOT NULL UNIQUE,
  public_key text NOT NULL,
  counter bigint DEFAULT 0,
  device_type text CHECK (device_type = ANY (ARRAY['platform'::text, 'cross-platform'::text])),
  device_name text,
  aaguid text,
  transports ARRAY,
  is_backup_eligible boolean DEFAULT false,
  is_backup_state boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  last_used_at timestamp with time zone,
  CONSTRAINT user_passkeys_pkey PRIMARY KEY (id),
  CONSTRAINT user_passkeys_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_payment_disputes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  transaction_id uuid,
  dispute_type text CHECK (dispute_type = ANY (ARRAY['unauthorized'::text, 'not_received'::text, 'not_as_described'::text, 'duplicate'::text, 'subscription_cancelled'::text, 'other'::text])),
  amount_disputed numeric NOT NULL,
  currency text DEFAULT 'BDT'::text,
  description text NOT NULL,
  evidence_urls ARRAY,
  status text DEFAULT 'open'::text CHECK (status = ANY (ARRAY['open'::text, 'under_review'::text, 'resolved_user'::text, 'resolved_merchant'::text, 'closed'::text, 'escalated'::text])),
  resolution_amount numeric,
  resolution_notes text,
  resolved_at timestamp with time zone,
  opened_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_payment_disputes_pkey PRIMARY KEY (id),
  CONSTRAINT user_payment_disputes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_payment_methods (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  method_type text NOT NULL CHECK (method_type = ANY (ARRAY['card'::text, 'bkash'::text, 'nagad'::text, 'rocket'::text, 'upay'::text, 'bank_transfer'::text, 'paypal'::text, 'stripe'::text, 'crypto'::text, 'other'::text])),
  label text,
  last_four text,
  card_brand text,
  expiry_month integer,
  expiry_year integer,
  account_number_masked text,
  is_default boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  token_reference text,
  created_at timestamp with time zone DEFAULT now(),
  nickname text,
  billing_name text,
  billing_address_id uuid,
  is_expired boolean DEFAULT false,
  last_used_at timestamp with time zone,
  use_count integer DEFAULT 0,
  failed_count integer DEFAULT 0,
  CONSTRAINT user_payment_methods_pkey PRIMARY KEY (id),
  CONSTRAINT user_payment_methods_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_privacy_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  analytics_consent boolean DEFAULT true,
  marketing_consent boolean DEFAULT false,
  personalization_consent boolean DEFAULT true,
  third_party_sharing boolean DEFAULT false,
  cookie_consent boolean DEFAULT true,
  data_retention_years integer DEFAULT 5,
  consented_at timestamp with time zone DEFAULT now(),
  last_updated timestamp with time zone DEFAULT now(),
  profile_search_visibility boolean DEFAULT true,
  show_online_status boolean DEFAULT true,
  show_last_seen boolean DEFAULT true,
  show_read_receipts boolean DEFAULT true,
  allow_friend_requests boolean DEFAULT true,
  allow_message_from text DEFAULT 'everyone'::text,
  allow_tag_from text DEFAULT 'friends'::text,
  discoverable_by_email boolean DEFAULT false,
  discoverable_by_phone boolean DEFAULT false,
  hide_from_search_engines boolean DEFAULT false,
  face_recognition_enabled boolean DEFAULT false,
  location_sharing_enabled boolean DEFAULT false,
  location_sharing_with text DEFAULT 'none'::text,
  sensitive_content_filter boolean DEFAULT true,
  ai_data_training_consent boolean DEFAULT false,
  cross_app_tracking boolean DEFAULT false,
  personalized_ads boolean DEFAULT true,
  data_retention_preference text DEFAULT 'standard'::text,
  auto_delete_activity_after_months integer DEFAULT 0,
  CONSTRAINT user_privacy_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_privacy_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_product_interactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  product_name text,
  category text,
  interaction_type text NOT NULL CHECK (interaction_type = ANY (ARRAY['view'::text, 'wishlist_add'::text, 'wishlist_remove'::text, 'cart_add'::text, 'cart_remove'::text, 'checkout_start'::text, 'purchase'::text, 'review'::text, 'share'::text, 'compare'::text])),
  view_count integer DEFAULT 1,
  time_spent_seconds integer DEFAULT 0,
  price_at_time numeric,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_product_interactions_pkey PRIMARY KEY (id),
  CONSTRAINT user_product_interactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_promo_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  code text NOT NULL,
  discount_type text CHECK (discount_type = ANY (ARRAY['percent'::text, 'fixed'::text, 'free_shipping'::text])),
  discount_value numeric,
  used_on_product text,
  order_id text,
  saving_amount numeric,
  used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_promo_codes_pkey PRIMARY KEY (id),
  CONSTRAINT user_promo_codes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_purchase_history_extended (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  purchase_id uuid,
  receipt_number text UNIQUE,
  tax_breakdown jsonb DEFAULT '{}'::jsonb,
  shipping_breakdown jsonb DEFAULT '{}'::jsonb,
  discount_breakdown jsonb DEFAULT '{}'::jsonb,
  payment_installments integer DEFAULT 1,
  gift_message text,
  special_instructions text,
  packaging_preference text,
  eco_packaging boolean DEFAULT false,
  carbon_offset_purchased boolean DEFAULT false,
  invoice_pdf_url text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_purchase_history_extended_pkey PRIMARY KEY (id),
  CONSTRAINT user_purchase_history_extended_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_purchases (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  order_id text NOT NULL UNIQUE,
  product_id text NOT NULL,
  product_name text,
  category text,
  quantity integer DEFAULT 1,
  unit_price numeric NOT NULL,
  total_price numeric NOT NULL,
  discount_amount numeric DEFAULT 0.00,
  coupon_code text,
  payment_method text,
  currency text DEFAULT 'BDT'::text,
  status text DEFAULT 'completed'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'refunded'::text, 'cancelled'::text])),
  is_gift boolean DEFAULT false,
  gift_for text,
  device_type text,
  ip_address inet,
  purchased_at timestamp with time zone DEFAULT now(),
  refunded_at timestamp with time zone,
  is_eco_friendly boolean DEFAULT false,
  carbon_footprint_kg numeric,
  sustainability_score integer CHECK (sustainability_score >= 0 AND sustainability_score <= 100),
  delivery_date date,
  review_reminder_sent boolean DEFAULT false,
  is_digital boolean DEFAULT false,
  download_link text,
  warranty_expires_at date,
  insurance_added boolean DEFAULT false,
  CONSTRAINT user_purchases_pkey PRIMARY KEY (id),
  CONSTRAINT user_purchases_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_push_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  token text NOT NULL UNIQUE,
  platform text NOT NULL CHECK (platform = ANY (ARRAY['android'::text, 'ios'::text, 'web'::text])),
  device_name text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  last_used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_push_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT user_push_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_recently_viewed (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  product_name text,
  viewed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_recently_viewed_pkey PRIMARY KEY (id),
  CONSTRAINT user_recently_viewed_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_referrals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  referrer_id uuid NOT NULL,
  referred_user_id uuid,
  referral_code text NOT NULL UNIQUE,
  referral_link text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'signed_up'::text, 'purchased'::text, 'rewarded'::text, 'expired'::text])),
  reward_type text,
  reward_amount numeric DEFAULT 0.00,
  reward_given boolean DEFAULT false,
  reward_given_at timestamp with time zone,
  referred_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_referrals_pkey PRIMARY KEY (id),
  CONSTRAINT user_referrals_referrer_id_fkey FOREIGN KEY (referrer_id) REFERENCES public.users(id),
  CONSTRAINT user_referrals_referred_user_id_fkey FOREIGN KEY (referred_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  action_type text NOT NULL CHECK (action_type = ANY (ARRAY['registration'::text, 'login_success'::text, 'login_failed'::text, 'logout'::text, 'otp_request'::text, 'otp_verified'::text, 'otp_failed'::text, 'password_change'::text, 'password_reset'::text, 'theme_change'::text, 'profile_update'::text, 'email_change'::text, 'mobile_change'::text, 'account_suspended'::text, 'account_banned'::text, 'account_deleted'::text, 'suspicious_activity'::text, 'rate_limit_exceeded'::text, 'session_expired'::text])),
  ip_address inet,
  device_info text,
  location text,
  status text NOT NULL DEFAULT 'success'::text CHECK (status = ANY (ARRAY['success'::text, 'failed'::text, 'suspicious'::text, 'blocked'::text])),
  notes text,
  metadata jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT user_reports_pkey PRIMARY KEY (id),
  CONSTRAINT user_reports_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_reputation (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  reputation_score integer DEFAULT 0,
  helpful_answers integer DEFAULT 0,
  quality_reviews integer DEFAULT 0,
  verified_purchases integer DEFAULT 0,
  community_contributions integer DEFAULT 0,
  spam_reports integer DEFAULT 0,
  level text DEFAULT 'newcomer'::text CHECK (level = ANY (ARRAY['newcomer'::text, 'contributor'::text, 'regular'::text, 'trusted'::text, 'expert'::text, 'legend'::text])),
  level_updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_reputation_pkey PRIMARY KEY (id),
  CONSTRAINT user_reputation_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_reviews (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  purchase_id uuid,
  rating integer NOT NULL CHECK (rating >= 1 AND rating <= 5),
  title text,
  body text,
  pros ARRAY,
  cons ARRAY,
  helpful_count integer DEFAULT 0,
  is_verified_purchase boolean DEFAULT false,
  is_featured boolean DEFAULT false,
  is_approved boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  media_urls ARRAY,
  seller_reply text,
  seller_replied_at timestamp with time zone,
  not_helpful_count integer DEFAULT 0,
  report_count integer DEFAULT 0,
  quality_score numeric DEFAULT 0,
  CONSTRAINT user_reviews_pkey PRIMARY KEY (id),
  CONSTRAINT user_reviews_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_reviews_purchase_id_fkey FOREIGN KEY (purchase_id) REFERENCES public.user_purchases(id)
);
CREATE TABLE public.user_rfm_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  rfm_recency_score integer,
  rfm_frequency_score integer,
  rfm_monetary_score integer,
  rfm_total_score integer,
  user_segment text,
  funnel_level integer,
  churn_risk_score integer,
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_rfm_history_pkey PRIMARY KEY (id),
  CONSTRAINT user_rfm_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_saved_cards_extended (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  payment_method_id uuid,
  card_art_url text,
  card_color text,
  display_name text,
  contactless_enabled boolean DEFAULT true,
  online_payments_enabled boolean DEFAULT true,
  international_enabled boolean DEFAULT false,
  transaction_limit_single numeric,
  transaction_limit_daily numeric,
  notification_on_use boolean DEFAULT true,
  add_to_apple_pay boolean DEFAULT false,
  add_to_google_pay boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_saved_cards_extended_pkey PRIMARY KEY (id),
  CONSTRAINT user_saved_cards_extended_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_saved_places (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  place_id uuid,
  custom_name text,
  label text CHECK (label = ANY (ARRAY['home'::text, 'work'::text, 'favorite'::text, 'want_to_go'::text, 'other'::text])),
  latitude numeric,
  longitude numeric,
  address text,
  saved_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_saved_places_pkey PRIMARY KEY (id),
  CONSTRAINT user_saved_places_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_saved_places_place_id_fkey FOREIGN KEY (place_id) REFERENCES public.map_places(id)
);
CREATE TABLE public.user_saved_searches (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  query text NOT NULL,
  filters jsonb DEFAULT '{}'::jsonb,
  alert_enabled boolean DEFAULT false,
  alert_frequency text DEFAULT 'daily'::text CHECK (alert_frequency = ANY (ARRAY['instant'::text, 'daily'::text, 'weekly'::text])),
  last_alerted_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_saved_searches_pkey PRIMARY KEY (id),
  CONSTRAINT user_saved_searches_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_screen_time (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  date date NOT NULL,
  total_minutes integer DEFAULT 0,
  app_breakdown jsonb DEFAULT '{}'::jsonb,
  category_breakdown jsonb DEFAULT '{}'::jsonb,
  pickups_count integer DEFAULT 0,
  notifications_received integer DEFAULT 0,
  longest_session_minutes integer DEFAULT 0,
  first_use_time time without time zone,
  last_use_time time without time zone,
  downtime_respected boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_screen_time_pkey PRIMARY KEY (id),
  CONSTRAINT user_screen_time_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_search_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  query text NOT NULL,
  result_count integer DEFAULT 0,
  clicked_result text,
  clicked_product_id text,
  device_type text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT user_search_history_pkey PRIMARY KEY (id),
  CONSTRAINT user_search_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_security_activity (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['login'::text, 'password_change'::text, '2fa_enabled'::text, '2fa_disabled'::text, 'recovery_email_added'::text, 'recovery_phone_added'::text, 'device_added'::text, 'device_removed'::text, 'app_connected'::text, 'app_disconnected'::text, 'suspicious_activity'::text, 'location_blocked'::text])),
  event_title text NOT NULL,
  event_description text,
  ip_address inet,
  location text,
  device_info text,
  was_you boolean,
  reported_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_security_activity_pkey PRIMARY KEY (id),
  CONSTRAINT user_security_activity_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_security_checkup (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  last_checkup_at timestamp with time zone DEFAULT now(),
  overall_score integer DEFAULT 0,
  password_strength text DEFAULT 'weak'::text,
  password_last_changed_days integer DEFAULT 0,
  two_factor_enabled boolean DEFAULT false,
  recovery_options_count integer DEFAULT 0,
  connected_apps_count integer DEFAULT 0,
  risky_apps_count integer DEFAULT 0,
  active_sessions_count integer DEFAULT 0,
  suspicious_sessions_count integer DEFAULT 0,
  recent_security_events integer DEFAULT 0,
  data_breach_detected boolean DEFAULT false,
  data_breach_details text,
  recommendations jsonb DEFAULT '[]'::jsonb,
  next_checkup_reminder timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_security_checkup_pkey PRIMARY KEY (id),
  CONSTRAINT user_security_checkup_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_segments (
  segment_id integer NOT NULL DEFAULT nextval('user_segments_segment_id_seq'::regclass),
  segment_code text NOT NULL UNIQUE,
  segment_name text NOT NULL,
  funnel_level integer,
  funnel_stage text,
  who_qualifies text,
  action_to_take text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_segments_pkey PRIMARY KEY (segment_id)
);
CREATE TABLE public.user_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  session_token text NOT NULL UNIQUE,
  device_info text,
  ip_address inet,
  location text,
  remember_me boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  last_activity timestamp with time zone NOT NULL DEFAULT now(),
  device_fingerprint text,
  is_trusted_device boolean DEFAULT false,
  user_agent text,
  browser_fingerprint jsonb,
  login_method text DEFAULT 'password'::text,
  is_suspicious boolean DEFAULT false,
  risk_score integer DEFAULT 0,
  logged_out_at timestamp with time zone,
  logout_reason text,
  login_notification_sent boolean DEFAULT false,
  country_code text,
  city_name text,
  os_name text,
  browser_name text,
  CONSTRAINT user_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT user_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_sessions_extended (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  session_token text NOT NULL UNIQUE,
  device_type text,
  os text,
  browser text,
  ip_address inet,
  location text,
  referral_source text,
  utm_source text,
  utm_medium text,
  utm_campaign text,
  pages_viewed integer DEFAULT 0,
  products_viewed integer DEFAULT 0,
  search_count integer DEFAULT 0,
  clicks_count integer DEFAULT 0,
  scroll_depth_max integer DEFAULT 0,
  session_duration_seconds integer DEFAULT 0,
  bounced boolean DEFAULT false,
  converted boolean DEFAULT false,
  conversion_value numeric DEFAULT 0.00,
  started_at timestamp with time zone DEFAULT now(),
  ended_at timestamp with time zone,
  CONSTRAINT user_sessions_extended_pkey PRIMARY KEY (id),
  CONSTRAINT user_sessions_extended_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_social_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  provider text NOT NULL CHECK (provider = ANY (ARRAY['google'::text, 'facebook'::text, 'apple'::text, 'twitter'::text, 'github'::text, 'linkedin'::text, 'tiktok'::text])),
  provider_user_id text NOT NULL,
  provider_email text,
  provider_name text,
  provider_avatar text,
  access_token_ref text,
  is_primary boolean DEFAULT false,
  linked_at timestamp with time zone DEFAULT now(),
  last_used_at timestamp with time zone,
  is_verified boolean DEFAULT false,
  follower_count integer DEFAULT 0,
  scope_granted ARRAY,
  can_post boolean DEFAULT false,
  auto_share_enabled boolean DEFAULT false,
  CONSTRAINT user_social_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT user_social_accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_social_graph (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  total_friends integer DEFAULT 0,
  total_followers integer DEFAULT 0,
  total_following integer DEFAULT 0,
  mutual_friends_avg integer DEFAULT 0,
  influence_score numeric DEFAULT 0,
  reach_score numeric DEFAULT 0,
  engagement_rate numeric DEFAULT 0,
  top_interaction_users jsonb DEFAULT '[]'::jsonb,
  community_memberships integer DEFAULT 0,
  groups_owned integer DEFAULT 0,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_social_graph_pkey PRIMARY KEY (id),
  CONSTRAINT user_social_graph_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_storage_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  total_storage_bytes bigint DEFAULT 0,
  used_storage_bytes bigint DEFAULT 0,
  free_storage_bytes bigint DEFAULT 0,
  drive_usage_bytes bigint DEFAULT 0,
  photos_usage_bytes bigint DEFAULT 0,
  gmail_usage_bytes bigint DEFAULT 0,
  other_usage_bytes bigint DEFAULT 0,
  storage_plan text DEFAULT 'free'::text CHECK (storage_plan = ANY (ARRAY['free'::text, 'basic'::text, 'standard'::text, 'premium'::text])),
  plan_expires_at timestamp with time zone,
  last_calculated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_storage_usage_pkey PRIMARY KEY (id),
  CONSTRAINT user_storage_usage_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_stories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  media_url text,
  media_type text CHECK (media_type = ANY (ARRAY['image'::text, 'video'::text, 'text'::text, 'boomerang'::text])),
  text_content text,
  background_color text DEFAULT '#6366f1'::text,
  stickers jsonb DEFAULT '[]'::jsonb,
  link_url text,
  view_count integer DEFAULT 0,
  is_active boolean DEFAULT true,
  expires_at timestamp with time zone DEFAULT (now() + '24:00:00'::interval),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_stories_pkey PRIMARY KEY (id),
  CONSTRAINT user_stories_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_streaks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  current_streak integer DEFAULT 0,
  longest_streak integer DEFAULT 0,
  last_checkin_date date,
  streak_started_at date,
  total_checkins integer DEFAULT 0,
  CONSTRAINT user_streaks_pkey PRIMARY KEY (id),
  CONSTRAINT user_streaks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_subscription_boxes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  box_name text NOT NULL,
  box_type text CHECK (box_type = ANY (ARRAY['beauty'::text, 'snacks'::text, 'books'::text, 'tech'::text, 'fashion'::text, 'custom'::text])),
  frequency text CHECK (frequency = ANY (ARRAY['weekly'::text, 'monthly'::text, 'quarterly'::text])),
  price numeric NOT NULL,
  preferences jsonb,
  next_delivery_date date,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'paused'::text, 'cancelled'::text, 'pending'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_subscription_boxes_pkey PRIMARY KEY (id),
  CONSTRAINT user_subscription_boxes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_subscription_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  subscription_id uuid,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['created'::text, 'upgraded'::text, 'downgraded'::text, 'paused'::text, 'resumed'::text, 'cancelled'::text, 'renewed'::text, 'expired'::text, 'trial_started'::text, 'trial_ended'::text, 'payment_failed'::text, 'refunded'::text])),
  from_plan text,
  to_plan text,
  amount_charged numeric,
  reason text,
  triggered_by text DEFAULT 'user'::text,
  ip_address inet,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_subscription_history_pkey PRIMARY KEY (id),
  CONSTRAINT user_subscription_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  plan_name text NOT NULL,
  plan_type text CHECK (plan_type = ANY (ARRAY['free'::text, 'basic'::text, 'pro'::text, 'enterprise'::text, 'custom'::text])),
  billing_cycle text CHECK (billing_cycle = ANY (ARRAY['monthly'::text, 'yearly'::text, 'lifetime'::text])),
  price numeric DEFAULT 0.00,
  currency text DEFAULT 'BDT'::text,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['trial'::text, 'active'::text, 'paused'::text, 'cancelled'::text, 'expired'::text])),
  trial_ends_at timestamp with time zone,
  current_period_start timestamp with time zone,
  current_period_end timestamp with time zone,
  cancelled_at timestamp with time zone,
  cancel_reason text,
  payment_method text,
  auto_renew boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  plan_id uuid,
  upgrade_from_plan text,
  downgrade_to_plan text,
  pause_reason text,
  pause_until timestamp with time zone,
  renewal_reminder_sent boolean DEFAULT false,
  failed_payment_count integer DEFAULT 0,
  last_failed_payment_at timestamp with time zone,
  CONSTRAINT user_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT user_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_subscriptions_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.subscription_plans(id)
);
CREATE TABLE public.user_support_tickets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  ticket_number text NOT NULL DEFAULT ((('TKT-'::text || to_char(now(), 'YYYYMMDD'::text)) || '-'::text) || substr(md5((random())::text), 1, 6)) UNIQUE,
  category text CHECK (category = ANY (ARRAY['billing'::text, 'technical'::text, 'account'::text, 'product'::text, 'other'::text])),
  priority text DEFAULT 'normal'::text CHECK (priority = ANY (ARRAY['low'::text, 'normal'::text, 'high'::text, 'urgent'::text])),
  subject text NOT NULL,
  message text NOT NULL,
  status text DEFAULT 'open'::text CHECK (status = ANY (ARRAY['open'::text, 'in_progress'::text, 'waiting_user'::text, 'resolved'::text, 'closed'::text])),
  assigned_to text,
  resolution text,
  satisfaction_rating integer CHECK (satisfaction_rating IS NULL OR satisfaction_rating >= 1 AND satisfaction_rating <= 5),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  assigned_agent_id uuid,
  escalated_at timestamp with time zone,
  escalation_reason text,
  sla_deadline timestamp with time zone,
  first_response_at timestamp with time zone,
  reopen_count integer DEFAULT 0,
  last_reopened_at timestamp with time zone,
  CONSTRAINT user_support_tickets_pkey PRIMARY KEY (id),
  CONSTRAINT user_support_tickets_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_support_tickets_assigned_agent_id_fkey FOREIGN KEY (assigned_agent_id) REFERENCES public.support_agents(id)
);
CREATE TABLE public.user_third_party_permissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  app_id uuid NOT NULL,
  permission_type text NOT NULL CHECK (permission_type = ANY (ARRAY['profile'::text, 'email'::text, 'contacts'::text, 'calendar'::text, 'photos'::text, 'location'::text, 'drive'::text, 'sensitive'::text])),
  granted_at timestamp with time zone DEFAULT now(),
  last_used_at timestamp with time zone,
  is_active boolean DEFAULT true,
  revoked_at timestamp with time zone,
  CONSTRAINT user_third_party_permissions_pkey PRIMARY KEY (id),
  CONSTRAINT user_third_party_permissions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_trusted_contacts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  trusted_user_id uuid,
  trusted_email text,
  trusted_name text,
  trusted_phone text,
  relationship text,
  can_help_recover_account boolean DEFAULT true,
  invitation_sent boolean DEFAULT false,
  invitation_accepted boolean DEFAULT false,
  invited_at timestamp with time zone,
  accepted_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_trusted_contacts_pkey PRIMARY KEY (id),
  CONSTRAINT user_trusted_contacts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_voice_activity (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  transcript text,
  audio_url text,
  duration_seconds integer,
  language text DEFAULT 'bn'::text,
  command_type text,
  was_successful boolean DEFAULT true,
  device_type text,
  app_context text,
  auto_delete_at timestamp with time zone,
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_voice_activity_pkey PRIMARY KEY (id),
  CONSTRAINT user_voice_activity_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_wallet_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  wallet_id uuid NOT NULL,
  user_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['topup'::text, 'purchase'::text, 'refund'::text, 'bonus'::text, 'withdrawal'::text, 'transfer_in'::text, 'transfer_out'::text, 'cashback'::text])),
  amount numeric NOT NULL,
  balance_after numeric NOT NULL,
  description text,
  reference_id text,
  status text DEFAULT 'completed'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'failed'::text, 'reversed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_wallet_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT user_wallet_transactions_wallet_id_fkey FOREIGN KEY (wallet_id) REFERENCES public.user_wallets(id),
  CONSTRAINT user_wallet_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_wallets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  balance numeric DEFAULT 0.00,
  currency text DEFAULT 'BDT'::text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  daily_limit numeric DEFAULT 50000,
  monthly_limit numeric DEFAULT 500000,
  withdrawal_pin_hash text,
  is_frozen boolean DEFAULT false,
  freeze_reason text,
  cashback_balance numeric DEFAULT 0,
  reward_balance numeric DEFAULT 0,
  CONSTRAINT user_wallets_pkey PRIMARY KEY (id),
  CONSTRAINT user_wallets_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_wishlist_lists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  list_name text NOT NULL DEFAULT 'My Wishlist'::text,
  is_public boolean DEFAULT false,
  item_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_wishlist_lists_pkey PRIMARY KEY (id),
  CONSTRAINT user_wishlist_lists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_wishlists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  product_name text,
  price_when_added numeric,
  current_price numeric,
  price_dropped boolean DEFAULT false,
  added_at timestamp with time zone DEFAULT now(),
  list_id uuid,
  CONSTRAINT user_wishlists_pkey PRIMARY KEY (id),
  CONSTRAINT user_wishlists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_wishlists_list_id_fkey FOREIGN KEY (list_id) REFERENCES public.user_wishlist_lists(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  username text NOT NULL UNIQUE CHECK (username ~ '^[a-z0-9._]{8,20}$'::text),
  login_id text NOT NULL UNIQUE CHECK (login_id ~* '^[a-z0-9._]+@prigod\.com$'::text),
  password_hash text NOT NULL CHECK (length(password_hash) = 64),
  first_name text NOT NULL CHECK (length(first_name) >= 2),
  last_name text NOT NULL CHECK (length(last_name) >= 2),
  email text NOT NULL UNIQUE CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text),
  mobile text CHECK (mobile IS NULL OR mobile ~ '^\+[1-9]\d{1,14}$'::text),
  address text NOT NULL CHECK (length(address) >= 10),
  dob date NOT NULL CHECK (dob <= (CURRENT_DATE - '16 years'::interval)),
  gender text NOT NULL CHECK (gender = ANY (ARRAY['Male'::text, 'Female'::text, 'Other'::text, 'Prefer not to say'::text])),
  is_email_verified boolean NOT NULL DEFAULT false,
  is_mobile_verified boolean NOT NULL DEFAULT false,
  account_status text NOT NULL DEFAULT 'active'::text CHECK (account_status = ANY (ARRAY['active'::text, 'suspended'::text, 'banned'::text, 'deleted'::text])),
  failed_login_attempts integer NOT NULL DEFAULT 0,
  last_failed_login timestamp with time zone,
  locked_until timestamp with time zone,
  theme_preference text NOT NULL DEFAULT 'purple'::text CHECK (theme_preference = ANY (ARRAY['purple'::text, 'ocean'::text, 'dark'::text, 'coral'::text, 'lime'::text, 'forest'::text, 'indigo'::text, 'royal'::text, 'sunset'::text, 'nature'::text])),
  last_login_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  auth_user_id uuid,
  extra_data jsonb,
  dynamic_data jsonb DEFAULT '{}'::jsonb,
  avatar_url text,
  avatar_base64 text,
  cover_photo_url text,
  bio text,
  marital_status text CHECK (marital_status IS NULL OR (marital_status = ANY (ARRAY['single'::text, 'married'::text, 'divorced'::text, 'widowed'::text, 'prefer_not_to_say'::text]))),
  has_children boolean DEFAULT false,
  education text,
  occupation text,
  company_name text,
  industry text,
  monthly_income_range text,
  religion text,
  lifestyle text,
  country text,
  city text,
  area text,
  postal_code text,
  timezone text,
  language text DEFAULT 'bn'::text,
  currency text DEFAULT 'BDT'::text,
  preferred_font_size text DEFAULT 'medium'::text CHECK (preferred_font_size IS NULL OR (preferred_font_size = ANY (ARRAY['small'::text, 'medium'::text, 'large'::text]))),
  preferred_layout text DEFAULT 'grid'::text CHECK (preferred_layout IS NULL OR (preferred_layout = ANY (ARRAY['grid'::text, 'list'::text]))),
  preferred_content_type text CHECK (preferred_content_type IS NULL OR (preferred_content_type = ANY (ARRAY['video'::text, 'text'::text, 'image'::text, 'mixed'::text]))),
  preferred_language text DEFAULT 'bn'::text,
  preferred_payment_method text,
  preferred_notification_time text,
  preferred_category text,
  favorite_color text,
  email_newsletter boolean DEFAULT true,
  sms_notification boolean DEFAULT false,
  whatsapp_notification boolean DEFAULT false,
  push_notification boolean DEFAULT true,
  most_active_day text,
  purchase_day_preference text,
  interests jsonb DEFAULT '{"music": false, "gaming": false, "sports": false, "travel": false, "parenting": false, "automotive": false, "technology": false, "environment": false, "photography": false, "real_estate": false, "food_cooking": false, "ai_automation": false, "books_reading": false, "fashion_style": false, "politics_news": false, "health_fitness": false, "education_learning": false, "finance_investment": false, "movies_entertainment": false, "business_entrepreneurship": false}'::jsonb,
  interest_scores jsonb DEFAULT '{}'::jsonb,
  device_type text CHECK (device_type IS NULL OR (device_type = ANY (ARRAY['mobile'::text, 'tablet'::text, 'desktop'::text]))),
  os text,
  browser text,
  screen_size text,
  connection_type text CHECK (connection_type IS NULL OR (connection_type = ANY (ARRAY['wifi'::text, '4g'::text, '5g'::text, '3g'::text, 'unknown'::text]))),
  app_version text,
  location_permission boolean DEFAULT false,
  camera_permission boolean DEFAULT false,
  device_fingerprint text,
  timezone_offset integer,
  behavior_data jsonb DEFAULT '{"top_page": null, "ad_history": [], "cart_count": 0, "active_hour": null, "last_search": null, "share_count": 0, "top_product": null, "bounce_count": 0, "top_category": null, "cart_abandoned": false, "wishlist_count": 0, "payment_started": false, "unused_features": [], "scroll_depth_avg": 0, "checkout_abandoned": false, "last_viewed_product": null, "most_clicked_button": null}'::jsonb,
  first_visit_at timestamp with time zone,
  total_visit_count integer DEFAULT 0,
  total_session_minutes integer DEFAULT 0,
  avg_session_minutes numeric DEFAULT 0.00,
  visits_per_week numeric DEFAULT 0.00,
  pages_per_session numeric DEFAULT 0.00,
  most_active_hour integer,
  days_since_last_activity integer DEFAULT 0,
  ads_seen_count integer DEFAULT 0,
  ads_clicked_count integer DEFAULT 0,
  ad_ctr numeric DEFAULT 0.0000,
  has_wishlist boolean DEFAULT false,
  has_cart_item boolean DEFAULT false,
  cart_abandoned boolean DEFAULT false,
  checkout_abandoned boolean DEFAULT false,
  payment_started boolean DEFAULT false,
  requested_refund boolean DEFAULT false,
  complaint_count integer DEFAULT 0,
  does_share boolean DEFAULT false,
  does_review boolean DEFAULT false,
  purchase_hour_preference text,
  total_purchase_count integer DEFAULT 0,
  total_spent numeric DEFAULT 0.00,
  average_order_value numeric DEFAULT 0.00,
  max_single_order_value numeric DEFAULT 0.00,
  first_purchase_date date,
  last_purchase_date date,
  top_purchase_category text,
  top_purchase_product text,
  is_subscriber boolean DEFAULT false,
  subscription_plan text,
  used_coupon boolean DEFAULT false,
  used_discount boolean DEFAULT false,
  is_trial_user boolean DEFAULT false,
  has_upgraded boolean DEFAULT false,
  has_downgraded boolean DEFAULT false,
  is_bulk_buyer boolean DEFAULT false,
  is_gift_buyer boolean DEFAULT false,
  referral_source text,
  referred_by uuid,
  referral_count integer DEFAULT 0,
  is_community_active boolean DEFAULT false,
  is_influencer boolean DEFAULT false,
  social_follower_count integer DEFAULT 0,
  social_following_count integer DEFAULT 0,
  helpful_review_count integer DEFAULT 0,
  use_case text,
  pain_point text,
  skill_level text DEFAULT 'beginner'::text CHECK (skill_level IS NULL OR (skill_level = ANY (ARRAY['beginner'::text, 'intermediate'::text, 'expert'::text]))),
  team_or_solo text DEFAULT 'solo'::text CHECK (team_or_solo IS NULL OR (team_or_solo = ANY (ARRAY['solo'::text, 'team'::text]))),
  use_type text DEFAULT 'personal'::text CHECK (use_type IS NULL OR (use_type = ANY (ARRAY['personal'::text, 'business'::text]))),
  previous_competitor text,
  switch_reason text,
  favorite_feature text,
  disliked_feature text,
  future_goals text,
  rfm_recency_score integer DEFAULT 0,
  rfm_frequency_score integer DEFAULT 0,
  rfm_monetary_score integer DEFAULT 0,
  rfm_total_score integer DEFAULT 0,
  user_segment text DEFAULT 'L1_COLD'::text,
  funnel_level integer DEFAULT 1,
  funnel_stage text DEFAULT 'Awareness'::text,
  segment_updated_at timestamp with time zone DEFAULT now(),
  churn_risk_score integer DEFAULT 0,
  is_at_risk boolean DEFAULT false,
  is_churned boolean DEFAULT false,
  is_price_sensitive boolean DEFAULT false,
  is_premium_seeker boolean DEFAULT false,
  is_deal_hunter boolean DEFAULT false,
  is_morning_user boolean DEFAULT false,
  is_night_owl boolean DEFAULT false,
  is_weekend_shopper boolean DEFAULT false,
  is_mobile_only boolean DEFAULT false,
  is_desktop_only boolean DEFAULT false,
  two_factor_enabled boolean NOT NULL DEFAULT false,
  two_factor_method text CHECK (two_factor_method = ANY (ARRAY['totp'::text, 'sms'::text, 'email'::text, 'backup_code'::text])),
  middle_name text,
  name_pronunciation text,
  pronouns text,
  custom_pronouns text,
  profile_url text,
  website_url text,
  profile_completion_percent integer DEFAULT 0,
  is_verified_user boolean DEFAULT false,
  verified_at timestamp with time zone,
  verification_badge_type text,
  account_type text DEFAULT 'personal'::text,
  is_public_figure boolean DEFAULT false,
  profile_visibility text DEFAULT 'public'::text,
  bio_visibility text DEFAULT 'public'::text,
  dob_visibility text DEFAULT 'friends'::text,
  gender_visibility text DEFAULT 'private'::text,
  phone_visibility text DEFAULT 'private'::text,
  email_visibility text DEFAULT 'private'::text,
  location_visibility text DEFAULT 'friends'::text,
  work_visibility text DEFAULT 'friends'::text,
  education_visibility text DEFAULT 'friends'::text,
  friends_visibility text DEFAULT 'friends'::text,
  posts_visibility text DEFAULT 'public'::text,
  tagged_posts_visibility text DEFAULT 'friends'::text,
  mobile_secondary text,
  recovery_email text,
  recovery_phone text,
  emergency_contact_name text,
  emergency_contact_phone text,
  emergency_contact_relation text,
  login_notify_every_login boolean DEFAULT true,
  login_notify_new_device_only boolean DEFAULT false,
  login_notify_via_email boolean DEFAULT true,
  login_notify_via_sms boolean DEFAULT false,
  login_notify_via_push boolean DEFAULT true,
  suspicious_login_block boolean DEFAULT true,
  password_change_notify boolean DEFAULT true,
  email_change_notify boolean DEFAULT true,
  phone_change_notify boolean DEFAULT true,
  last_password_change timestamp with time zone,
  password_strength_score integer DEFAULT 0,
  passkey_enabled boolean DEFAULT false,
  magic_link_enabled boolean DEFAULT false,
  biometric_enabled boolean DEFAULT false,
  auto_logout_minutes integer DEFAULT 30,
  session_limit integer DEFAULT 5,
  require_password_on_sensitive boolean DEFAULT true,
  search_visibility boolean DEFAULT true,
  discoverable_by_email boolean DEFAULT false,
  discoverable_by_phone boolean DEFAULT false,
  show_online_status boolean DEFAULT true,
  show_last_seen boolean DEFAULT true,
  show_read_receipts boolean DEFAULT true,
  show_typing_indicator boolean DEFAULT true,
  allow_friend_requests boolean DEFAULT true,
  allow_message_from text DEFAULT 'everyone'::text,
  allow_tag_from text DEFAULT 'friends'::text,
  allow_mention_from text DEFAULT 'everyone'::text,
  hide_from_search_engines boolean DEFAULT false,
  face_recognition_opt_out boolean DEFAULT false,
  ai_training_opt_out boolean DEFAULT false,
  sensitive_content_filter boolean DEFAULT true,
  cross_app_tracking_disabled boolean DEFAULT false,
  data_download_requested_at timestamp with time zone,
  account_delete_requested_at timestamp with time zone,
  account_delete_scheduled_at timestamp with time zone,
  notif_email_master boolean DEFAULT true,
  notif_sms_master boolean DEFAULT false,
  notif_push_master boolean DEFAULT true,
  notif_in_app_master boolean DEFAULT true,
  notif_whatsapp_master boolean DEFAULT false,
  dark_mode boolean DEFAULT false,
  auto_dark_mode boolean DEFAULT false,
  compact_mode boolean DEFAULT false,
  animation_enabled boolean DEFAULT true,
  high_contrast boolean DEFAULT false,
  reduce_motion boolean DEFAULT false,
  sidebar_collapsed boolean DEFAULT false,
  font_scale numeric DEFAULT 1.0,
  date_format text DEFAULT 'DD/MM/YYYY'::text,
  time_format text DEFAULT '12h'::text,
  first_day_of_week text DEFAULT 'Sunday'::text,
  number_format text DEFAULT 'comma'::text,
  measurement_unit text DEFAULT 'metric'::text,
  screen_reader_enabled boolean DEFAULT false,
  keyboard_shortcuts_enabled boolean DEFAULT true,
  focus_mode boolean DEFAULT false,
  dyslexia_friendly_font boolean DEFAULT false,
  color_blind_mode text DEFAULT 'none'::text,
  closed_captions_enabled boolean DEFAULT false,
  audio_description_enabled boolean DEFAULT false,
  last_login_ip inet,
  last_login_user_agent text,
  last_login_country text,
  last_login_city text,
  current_login_at timestamp with time zone,
  current_login_ip inet,
  current_login_user_agent text,
  current_login_country text,
  current_login_city text,
  login_count integer DEFAULT 0,
  session_count integer DEFAULT 0,
  preferred_currency text DEFAULT 'BDT'::text,
  preferred_timezone text DEFAULT 'Asia/Dhaka'::text,
  preferred_theme text DEFAULT 'system'::text,
  wallet_balance numeric DEFAULT 0.00,
  wallet_currency text DEFAULT 'BDT'::text,
  daily_wallet_limit numeric DEFAULT 50000.00,
  monthly_wallet_limit numeric DEFAULT 500000.00,
  wallet_is_frozen boolean DEFAULT false,
  wallet_freeze_reason text,
  stripe_customer_id text,
  paypal_customer_id text,
  account_created_from_ip inet,
  account_created_user_agent text,
  timezone_offset_minutes integer,
  dark_mode_enabled boolean DEFAULT false,
  reduced_motion_enabled boolean DEFAULT false,
  high_contrast_enabled boolean DEFAULT false,
  accessibility_settings jsonb DEFAULT '{}'::jsonb,
  marketing_consent boolean DEFAULT false,
  personalization_consent boolean DEFAULT true,
  third_party_sharing boolean DEFAULT false,
  cookie_consent boolean DEFAULT true,
  data_retention_years integer DEFAULT 5,
  consented_at timestamp with time zone DEFAULT now(),
  last_updated timestamp with time zone DEFAULT now(),
  totp_secret text,
  totp_qr_code text,
  backup_codes_encrypted text,
  backup_codes_generated_at timestamp with time zone,
  backup_codes_count integer DEFAULT 0,
  passkeys jsonb DEFAULT '[]'::jsonb,
  email_verification_token text,
  email_verification_sent_at timestamp with time zone,
  email_verified_at timestamp with time zone,
  phone_verification_token text,
  phone_verification_sent_at timestamp with time zone,
  phone_verified_at timestamp with time zone,
  password_reset_token text,
  password_reset_sent_at timestamp with time zone,
  password_reset_expires_at timestamp with time zone,
  is_locked boolean DEFAULT false,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id),
  CONSTRAINT users_referred_by_fkey FOREIGN KEY (referred_by) REFERENCES public.users(id)
);
CREATE TABLE public.video_calls (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  caller_id uuid NOT NULL,
  callee_id uuid NOT NULL,
  call_type text CHECK (call_type = ANY (ARRAY['video'::text, 'audio'::text, 'screen_share'::text])),
  duration_seconds integer,
  status text CHECK (status = ANY (ARRAY['completed'::text, 'missed'::text, 'declined'::text, 'failed'::text])),
  recording_url text,
  started_at timestamp with time zone DEFAULT now(),
  ended_at timestamp with time zone,
  CONSTRAINT video_calls_pkey PRIMARY KEY (id),
  CONSTRAINT video_calls_caller_id_fkey FOREIGN KEY (caller_id) REFERENCES public.users(id),
  CONSTRAINT video_calls_callee_id_fkey FOREIGN KEY (callee_id) REFERENCES public.users(id)
);
CREATE TABLE public.virtual_try_on_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  product_id text NOT NULL,
  try_on_type text CHECK (try_on_type = ANY (ARRAY['ar_furniture'::text, 'ar_fashion'::text, 'vr_room'::text, 'color_visualizer'::text, '3d_model'::text])),
  image_url text,
  feedback text,
  did_purchase boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT virtual_try_on_history_pkey PRIMARY KEY (id),
  CONSTRAINT virtual_try_on_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.voice_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sender_id uuid NOT NULL,
  receiver_id uuid,
  conversation_id uuid,
  audio_url text NOT NULL,
  duration_seconds integer,
  transcript text,
  is_transcribed boolean DEFAULT false,
  is_played boolean DEFAULT false,
  played_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT voice_messages_pkey PRIMARY KEY (id),
  CONSTRAINT voice_messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(id),
  CONSTRAINT voice_messages_receiver_id_fkey FOREIGN KEY (receiver_id) REFERENCES public.users(id)
);
CREATE TABLE public.webhooks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  endpoint_url text NOT NULL,
  secret text NOT NULL,
  events ARRAY NOT NULL,
  is_active boolean DEFAULT true,
  success_count integer DEFAULT 0,
  failure_count integer DEFAULT 0,
  last_triggered_at timestamp with time zone,
  last_status_code integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT webhooks_pkey PRIMARY KEY (id),
  CONSTRAINT webhooks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.whatsapp_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recipient_phone text NOT NULL,
  recipient_user_id uuid,
  message_type text DEFAULT 'text'::text CHECK (message_type = ANY (ARRAY['text'::text, 'template'::text, 'image'::text, 'document'::text, 'audio'::text, 'video'::text, 'interactive'::text])),
  content text,
  template_name text,
  template_variables jsonb DEFAULT '{}'::jsonb,
  media_url text,
  status text DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'sent'::text, 'delivered'::text, 'read'::text, 'failed'::text])),
  wa_message_id text,
  scheduled_at timestamp with time zone DEFAULT now(),
  sent_at timestamp with time zone,
  delivered_at timestamp with time zone,
  read_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT whatsapp_queue_pkey PRIMARY KEY (id),
  CONSTRAINT whatsapp_queue_recipient_user_id_fkey FOREIGN KEY (recipient_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.workspace_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workspace_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text DEFAULT 'member'::text CHECK (role = ANY (ARRAY['owner'::text, 'admin'::text, 'editor'::text, 'viewer'::text, 'guest'::text])),
  permissions jsonb DEFAULT '{"read": true, "write": false, "delete": false}'::jsonb,
  joined_at timestamp with time zone DEFAULT now(),
  CONSTRAINT workspace_members_pkey PRIMARY KEY (id),
  CONSTRAINT workspace_members_workspace_id_fkey FOREIGN KEY (workspace_id) REFERENCES public.shared_workspaces(id),
  CONSTRAINT workspace_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.zipra_apps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  app_key text NOT NULL UNIQUE,
  app_name text NOT NULL,
  app_tagline text,
  app_description text,
  product_id text,
  app_icon_url text,
  app_icon_svg text,
  app_color text DEFAULT '#6366f1'::text,
  app_url text NOT NULL,
  sso_enabled boolean DEFAULT true,
  sso_redirect_uri text,
  allowed_scopes ARRAY DEFAULT ARRAY['read:profile'::text, 'read:email'::text],
  requires_subscription boolean DEFAULT false,
  min_plan text DEFAULT 'free'::text,
  is_active boolean DEFAULT true,
  is_launched boolean DEFAULT false,
  launched_at date,
  display_order integer DEFAULT 0,
  total_users integer DEFAULT 0,
  daily_active_users integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT zipra_apps_pkey PRIMARY KEY (id),
  CONSTRAINT zipra_apps_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.zipra_products(product_id)
);
CREATE TABLE public.zipra_products (
  id integer NOT NULL DEFAULT nextval('zipra_products_id_seq'::regclass),
  product_id character varying NOT NULL UNIQUE,
  product_name character varying NOT NULL,
  product_url character varying NOT NULL,
  description text,
  long_description text,
  product_type character varying,
  type_label character varying,
  benefits jsonb,
  features jsonb,
  process_steps jsonb,
  setup_guide text,
  tags character varying,
  requirements text,
  documentation_url character varying,
  support_url character varying,
  icon_url character varying,
  banner_url text,
  screenshot_urls jsonb,
  is_active boolean DEFAULT true,
  is_featured boolean DEFAULT false,
  display_order integer DEFAULT 0,
  target_audience character varying,
  pricing_type character varying,
  price numeric,
  currency character varying DEFAULT 'USD'::character varying,
  version character varying,
  total_users integer DEFAULT 0,
  rating numeric,
  review_count integer DEFAULT 0,
  meta_title character varying,
  meta_description text,
  keywords character varying,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  launched_at date,
  icon_svg text,
  CONSTRAINT zipra_products_pkey PRIMARY KEY (id)
);